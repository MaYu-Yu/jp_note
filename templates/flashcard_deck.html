<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—å¡å­¸ç¿’</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .flashcard-container {
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding-top: 5vh;
        }

        .flashcard {
            width: 95%;
            max-width: 900px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            min-height: 350px;
        }

        /* ğŸš¨ æ¨™é¡Œå¯é»æ“Šæ¨£å¼ */
        .card-header-main {
            padding: 1.5rem 2rem;
            background-color: #d6eaff;
            border-bottom: 2px solid #007bff;
            border-radius: 0.5rem 0.5rem 0 0;
            font-size: 1.2rem;
            color: #007bff;
            font-weight: bold;
            cursor: pointer;
            /* è®“æ¨™é¡Œå…·å‚™é»æ“Šæç¤º */
        }

        .card-body {
            padding: 2rem;
            text-align: left;
        }

        /* ğŸš¨ ç¬¬ä¸€è¡Œ: æ—¥èªã€è©æ€§ã€èªéŸ³ (æœ€å¤§) */
        .term-line {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 1.5rem;
            cursor: pointer;
            /* é»æ“Šæ­¤è¡Œå¯é–‹åˆç­”æ¡ˆ */
        }

        .term-text {
            font-size: 3rem;
            font-weight: bold;
            color: #007bff;
            margin: 0;
            line-height: 1.2;
        }

        .pos-badge {
            margin-left: 15px;
            font-size: 1.2rem;
        }

        .tts-button {
            cursor: pointer;
            color: #28a745;
            margin-left: 10px;
            font-size: 1.5em;
            vertical-align: top;
            transition: color 0.2s;
        }

        .tts-button:hover {
            color: #1e7e34;
        }

        /* ğŸš¨ ç¬¬äºŒè¡Œ: è§£é‡‹/ä¸­æ–‡æ„æ€ */
        .explanation-line {
            margin-bottom: 1.5rem;
        }

        /* ğŸš¨ ç¬¬ä¸‰è¡Œ: ä¾‹å¥ */
        .example-line {
            margin-bottom: 0;
        }

        .content-label {
            font-weight: bold;
            color: #6c757d;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
        }

        .content-text {
            margin-bottom: 1rem;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .explanation-style {
            color: #343a40;
            padding: 10px;
            background-color: #e9f5ff;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }

        .example-style {
            color: #343a40;
            padding: 10px;
            background-color: #f7f7f7;
            border-left: 4px solid #28a745;
            border-radius: 4px;
            cursor: pointer;
        }

        /* ğŸš¨ Issue 4 ä¿®æ­£ï¼šä½ˆå±€èª¿æ•´ï¼šå¡ç‰‡ä¸‹æ–¹çš„æŒ‰éˆ•ç¾¤çµ„ */
        .control-row-main {
            width: 95%;
            /* ç¢ºä¿å’Œå¡ç‰‡ä¸€æ¨£å¯¬ */
            max-width: 900px;
            display: flex;
            flex-direction: column;
            /* è¨­ç‚ºç¸±å‘æ’åˆ—çš„å®¹å™¨ */
            align-items: center;
            /* è®“å…§å®¹å±…ä¸­ */
            gap: 15px;
            /* å¢åŠ é–“è· */
        }

        /* ğŸš¨ Issue 4 ä¿®æ­£ï¼šPrev/Next æ“´å±•åˆ°å…©å´ */
        .control-row-nav {
            display: flex;
            width: 100%;
            justify-content: space-between;
            gap: 15px;
            /* æŒ‰éˆ•é–“è· */
        }

        .control-row-nav .btn-lg {
            flex-grow: 1;
            max-width: 48%;
            /* è®“å…©å€‹æŒ‰éˆ•å¹³å‡åˆ†é…å¯¬åº¦ */
        }

        /* ğŸš¨ Issue 4 ä¿®æ­£ï¼šReset/Autoplay/Replay å±…ä¸­ */
        .control-row-center {
            display: flex;
            flex-wrap: wrap; /* å…è¨±æ›è¡Œ */
            gap: 15px;
            justify-content: center;
            /* æ ¸å¿ƒï¼šå±…ä¸­ */
            align-items: center;
        }

        /* è®“ Select æ¡†åœ¨å°è¢å¹•ä¸‹ä¿æŒåˆç†å¯¬åº¦ */
        .autoplay-controls .form-select {
            width: 100px;
        }
    </style>
</head>

<body>
    <div class="container flashcard-container">
        <div class="row w-100 justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="card flashcard shadow">
                    <div class="card-header card-header-main" id="flashcard-header" data-bs-toggle="collapse"
                        data-bs-target="#explanation-content" aria-expanded="false" aria-controls="explanation-content">
                        å–®å­—å¡ç‰Œçµ„ï¼š{{ filter_summary }}
                    </div>

                    <div class="card-body">

                        <div class="text-center mb-4">
                            <span id="current-index-display" class="h5 text-dark fw-bold me-3">
                                è¼‰å…¥ä¸­...
                            </span>
                        </div>

                        <div class="term-line" id="term-line-clickable" data-bs-toggle="collapse"
                            data-bs-target="#explanation-content" aria-expanded="false"
                            aria-controls="explanation-content">
                            <h2 class="term-text" id="card-term">
                            </h2>
                            <span id="card-pos" class="pos-badge badge bg-primary">
                            </span>
                            <span class="tts-button" id="term-tts-btn">ğŸ”Š</span> 
                            <span id="card-type-info" class="ms-auto text-secondary small"></span>
                        </div>

                        <div class="collapse" id="explanation-content">
                            <div class="explanation-line">
                                <p class="content-label">è§£é‡‹/ä¸­æ–‡æ„æ€:</p>
                                <p class="content-text explanation-style" id="card-explanation">
                                </p>
                            </div>

                            <div class="example-line">
                                <p class="content-label">ä¾‹å¥ (é»æ“Šå¯ç¿»è­¯):
                                    <span class="tts-button" id="example-tts-btn">ğŸ”Š</span>
                                </p>
                                <p class="content-text example-style" id="card-example" 
                                    onclick="openGoogleTranslate(currentCardData.example_sentence)">
                                </p>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="control-row-main mt-4">

            <div class="control-row-nav">
                <button id="prev-btn" class="btn btn-warning btn-lg" onclick="navigateCard(-1)">â† ä¸Šä¸€å¼µ</button>

                <button id="next-btn" class="btn btn-success btn-lg" onclick="handleNextClick()">ä¸‹ä¸€å¼µ/çœ‹ç­”æ¡ˆ â†’</button>
            </div>
            
            <hr class="my-3 w-100">

            <div class="control-row-center">
                <a href="{{ url_for('flashcard_select') }}" class="btn btn-secondary me-3">âš™ï¸ é‡è¨­ç‰Œçµ„</a>

                <div class="autoplay-controls d-flex flex-nowrap align-items-center">
                    <select id="interval-select" class="form-select w-auto me-2">
                        <option value="1000">1 ç§’</option>
                        <option value="2000">2 ç§’</option>
                        <option value="3000">3 ç§’</option>
                        <option value="4000">4 ç§’</option>
                        <option value="5000" selected>5 ç§’</option>
                        <option value="6000">6 ç§’</option>
                        <option value="7000">7 ç§’</option>
                        <option value="8000">8 ç§’</option>
                        <option value="9000">9 ç§’</option>
                        <option value="10000">10 ç§’</option>
                    </select>
                    <button id="play-pause-btn" class="btn btn-primary" onclick="toggleAutoPlay()">â–¶ï¸ è‡ªå‹•æ’­æ”¾</button>
                </div>
                
                <button id="replay-btn" class="btn btn-info" onclick="speakFullAnswerWithCancel()">ğŸ”Š é‡å”¸ç­”æ¡ˆ</button>

            </div>

        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // =================================================================
        // æ ¸å¿ƒè®Šæ•¸å’Œå…ƒç´ å®šç¾© (ä¿æŒä¸è®Š)
        // =================================================================
        const BATCH_SIZE = 50;
        let current_index = {{ current_index }};
        const total_count = {{ total_count }};
        let currentCardData = null; // å¾ä¼ºæœå™¨è¼‰å…¥çš„ç•¶å‰å¡ç‰‡æ•¸æ“š

        let cardCache = [];
        let currentBatchStart = 0;

        // å…ƒç´ é¸æ“‡å™¨
        const indexDisplay = document.getElementById('current-index-display');
        const termElement = document.getElementById('card-term');
        const posElement = document.getElementById('card-pos');
        const explanationElement = document.getElementById('card-explanation');
        const exampleElement = document.getElementById('card-example');
        const contentCollapse = document.getElementById('explanation-content');
        const typeInfoElement = document.getElementById('card-type-info');
        const termLine = document.getElementById('term-line-clickable'); // æ•´å€‹å¯é»æ“Šå€åŸŸ
        const headerElement = document.getElementById('flashcard-header'); // æ¨™é ­å…ƒç´ 
        const nextButton = document.getElementById('next-btn');

        const intervalSelect = document.getElementById('interval-select');
        const playPauseBtn = document.getElementById('play-pause-btn');

        // è‡ªå‹•æ’­æ”¾ç›¸é—œè®Šæ•¸
        const SESSION_KEY = 'flashcard_autoplay_enabled';
        const INTERVAL_KEY = 'flashcard_autoplay_interval';
        let autoPlayTimeout = null;
        let isSpeaking = false;


        // =================================================================
        // èªéŸ³åˆæˆ (TTS) é‚è¼¯
        // =================================================================
        /**
         * åŸ·è¡ŒèªéŸ³æ’­æ”¾ã€‚
         * @param {string} text è¦æ’­æ”¾çš„æ–‡æœ¬ã€‚
         * @param {string} lang èªè¨€ä»£ç¢¼ (e.g., 'ja-JP', 'zh-TW')ã€‚
         * @param {function} callback æ’­æ”¾å®Œæˆå¾Œçš„å›èª¿å‡½æ•¸ã€‚
         */
        function speakText(text, lang, callback = () => {}) {
            if (!('speechSynthesis' in window) || !text || text.trim() === '') {
                callback();
                return;
            }

            // ğŸš¨ Issue 3 ä¿®æ­£: åœæ­¢æ‰€æœ‰ç•¶å‰èªéŸ³
            window.speechSynthesis.cancel(); 

            let textToSpeak = text.trim();

            if (lang === 'ja-JP') {
                // è™•ç†æ—¥èª: æå– [ ] å…§çš„æ ¸å¿ƒæ–‡æ³•æˆ– + è™Ÿå‰é¢çš„éƒ¨åˆ†
                const match = textToSpeak.match(/\[([^\]]+)\]/);
                if (match && match[1]) {
                    textToSpeak = match[1].trim();
                } else {
                    textToSpeak = textToSpeak.split('+')[0].trim();
                }
            }
            
            if (textToSpeak) {
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = (lang === 'zh-TW') ? 'zh-TW' : 'ja-JP';
                utterance.rate = 1.0;
                
                // èªéŸ³æ’­æ”¾çµæŸ
                utterance.onend = () => {
                    isSpeaking = false;
                    callback();
                };

                // èªéŸ³æ’­æ”¾éŒ¯èª¤
                utterance.onerror = (e) => {
                    console.error('TTS Error:', e);
                    isSpeaking = false;
                    callback();
                };

                isSpeaking = true;
                window.speechSynthesis.speak(utterance);
            } else {
                callback();
            }
        }

        /**
         * ğŸš¨ æ ¸å¿ƒTTSå‡½æ•¸ï¼šä¾åºæ’­æ”¾æ—¥èª Term, ä¸­æ–‡è§£é‡‹, æ—¥èªä¾‹å¥
         * @param {function} callback - å…¨éƒ¨æ’­æ”¾å®Œç•¢å¾ŒåŸ·è¡Œçš„å›èª¿å‡½æ•¸
         */
        function speakFullAnswer(callback = () => {}) {
            if (!currentCardData || currentCardData.type === 'error') {
                callback();
                return;
            }
            
            // ğŸš¨ ä¿®æ­£ Issue 3: ç¢ºä¿é–‹å§‹æ’­æ”¾æ–°åºåˆ—å‰ï¼Œå…ˆåœæ­¢æ‰€æœ‰èªéŸ³
            window.speechSynthesis.cancel(); 

            // 1. æ’­æ”¾æ—¥èª Term
            speakText(currentCardData.term, 'ja-JP', () => {
                // 2. æ’­æ”¾ä¸­æ–‡è§£é‡‹
                const explanationText = explanationElement.textContent;
                // ğŸš¨ ä¿®æ­£: ç‚ºäº†é¿å… speakText å…§éƒ¨çš„ cancel å½±éŸ¿åˆ°ä¸‹ä¸€å€‹ speakï¼Œ
                // é€™è£¡æˆ‘å€‘ç›´æ¥ä½¿ç”¨ä¸€å€‹ä¸å¸¶ cancel çš„å…§éƒ¨å‡½æ•¸ä¾†å¯¦ç¾ä¸²è¯ã€‚
                
                // ç‚ºäº†ä½¿ç”¨å·²æœ‰çš„ speakText å‡½æ•¸ï¼ˆå®ƒåŒ…å« cancelï¼‰ï¼Œæˆ‘å€‘å¿…é ˆä½¿ç”¨éè¿´ï¼Œ
                // ä½†å› ç‚º navigateCard æœƒé‡æ–°è¼‰å…¥é é¢ï¼Œæˆ‘å€‘åªéœ€ç¢ºä¿é€™è£¡èªéŸ³æ˜¯é€£çºŒçš„ï¼Œ
                // æ‰€ä»¥æˆ‘å€‘ç”¨é€£çºŒçš„å›èª¿ã€‚speakText å…§çš„ cancel å·²ç¶“è¶³å¤ ã€‚
                
                speakText(explanationText, 'zh-TW', () => {
                    // 3. æ’­æ”¾æ—¥èªä¾‹å¥
                    const exampleText = exampleElement.textContent;
                    speakText(exampleText, 'ja-JP', () => {
                        // 4. å…¨éƒ¨å®Œæˆ
                        callback();
                    });
                });
            });
        }
        
        /**
         * ğŸš¨ ä¾›ã€Œé‡å”¸ç­”æ¡ˆã€æŒ‰éˆ•ä½¿ç”¨çš„å‡½æ•¸ï¼Œç¢ºä¿å…ˆåœæ­¢å¾Œæ’­æ”¾ã€‚
         */
        function speakFullAnswerWithCancel() {
            stopAutoPlayLoop(false); // åœæ­¢è‡ªå‹•æ’­æ”¾ï¼Œä½†ä¸æ”¹è®ŠæŒ‰éˆ•ç‹€æ…‹
            window.speechSynthesis.cancel(); // ğŸš¨ ç¢ºä¿åœæ­¢ç•¶å‰æ‰€æœ‰èªéŸ³
            // ç¢ºä¿ç­”æ¡ˆæ˜¯å±•é–‹çš„
            if (!contentCollapse.classList.contains('show')) {
                // ä½¿ç”¨ Bootstrap JS ä¾†è§¸ç™¼é–‹åˆï¼Œç¢ºä¿æ¨£å¼æ­£ç¢º
                new bootstrap.Collapse(contentCollapse, { toggle: true });
            }
            // å»¶é²æ’­æ”¾ï¼Œç¢ºä¿é–‹åˆå‹•ç•«å®Œæˆ
            setTimeout(() => {
                speakFullAnswer(() => { /* do nothing */ });
            }, 500);
        }

        // =================================================================
        // Google ç¿»è­¯é€£çµåŠŸèƒ½
        // =================================================================
        function openGoogleTranslate(text) {
            stopAutoPlayLoop(false); // åœæ­¢è‡ªå‹•æ’­æ”¾
            window.speechSynthesis.cancel(); // ğŸš¨ ç¿»è­¯å‰å–æ¶ˆèªéŸ³
            const encodedText = encodeURIComponent(text);
            const url = `https://translate.google.com/?sl=ja&tl=zh-TW&text=${encodedText}&op=translate`;
            window.open(url, '_blank');
            return false;
        }

        // =================================================================
        // AJAX æ‰¹æ¬¡è¼‰å…¥å’Œç·©å­˜ç®¡ç† (ä¿æŒä¸è®Š)
        // =================================================================
        async function fetchAndCacheBatch(startIndex) {
            if (startIndex >= total_count) {
                cardCache = [];
                currentBatchStart = total_count;
                return;
            }
            termElement.textContent = 'â³ è¼‰å…¥ä¸‹ä¸€æ‰¹å¡ç‰‡...';
            posElement.style.display = 'none';
            typeInfoElement.textContent = '';
            explanationElement.textContent = '';
            exampleElement.textContent = '';
            contentCollapse.classList.remove('show');
            nextButton.textContent = 'ä¸‹ä¸€å¼µ/çœ‹ç­”æ¡ˆ â†’'; // é‡ç½®æŒ‰éˆ•æ–‡å­—
            try {
                const response = await fetch(`/api/get_flashcard/${startIndex}`);
                const result = await response.json();
                if (result.success) {
                    cardCache = result.cards;
                    currentBatchStart = startIndex;
                } else {
                    cardCache = [];
                    currentBatchStart = startIndex;
                }
            } catch (error) {
                cardCache = [];
                currentBatchStart = startIndex;
            }
        }

        /**
         * æ­¥é©Ÿ 2: æ¸²æŸ“å¡ç‰‡å…§å®¹åˆ° HTML
         * @param {object} card - å¡ç‰‡æ•¸æ“š
         * @param {boolean} autoSpeak - æ˜¯å¦è‡ªå‹•æ’­æ”¾ term èªéŸ³ (é–‹å•Ÿå¡ç‰‡å³æ’­æ”¾)
         */
        function renderCard(card, autoSpeak = false) {
            currentCardData = card;
            
            // 1. æ›´æ–°ç´¢å¼•é¡¯ç¤º
            indexDisplay.textContent = `ç¬¬ ${current_index + 1} / ${total_count} ç­†`;

            // 2. æ¸²æŸ“æ ¸å¿ƒå…§å®¹
            termElement.textContent = card.term || 'N/A';
            posElement.textContent = card.part_of_speech || '';
            posElement.style.display = card.part_of_speech ? 'inline-block' : 'none';

            explanationElement.innerHTML = card.explanation ? card.explanation.replace(/\n/g, '<br>') : 'N/A';
            exampleElement.innerHTML = card.example_sentence ? card.example_sentence.replace(/\n/g, '<br>') : 'N/A';
            
            typeInfoElement.textContent = card.type === 'vocab' ? 'å–®å­—' : (card.type === 'grammar' ? 'æ–‡æ³•' : '');
            
            // 3. é‡ç½®ç­”æ¡ˆé¡¯ç¤ºç‹€æ…‹
            contentCollapse.classList.remove('show');
            nextButton.textContent = 'ä¸‹ä¸€å¼µ/çœ‹ç­”æ¡ˆ â†’';
            
            // 4. æ¯æ¬¡è¼‰å…¥æ–°å¡ç‰‡æ™‚è‡ªå‹•æ’­æ”¾æ—¥èªç™¼éŸ³ (åªè®€ Term)
            if (autoSpeak) {
                // é€™è£¡åªè®€ Termï¼Œå› ç‚º navigateCard å·²ç¶“æ˜¯è·³åˆ°ä¸‹ä¸€å¼µäº†ï¼Œé€šå¸¸ä¸è®€ç­”æ¡ˆ
                speakText(card.term, 'ja-JP'); 
            }
        }

        /**
         * æ­¥é©Ÿ 3: å°èˆªè‡³ä¸‹ä¸€å¼µ/ä¸Šä¸€å¼µå¡ç‰‡ï¼Œä¸¦æ›´æ–°å¾Œç«¯ç´¢å¼•
         */
        async function navigateCard(step) {
            if (total_count === 0) return;
            // ğŸš¨ Issue 3 ä¿®æ­£: å°èˆªå‰åœæ­¢æ‰€æœ‰èªéŸ³
            window.speechSynthesis.cancel(); 
            
            // å¦‚æœåœ¨è‡ªå‹•æ’­æ”¾æ¨¡å¼ä¸‹ï¼Œå¿…é ˆå…ˆåœæ­¢è¨ˆæ™‚å™¨
            if (sessionStorage.getItem(SESSION_KEY) === 'true' && autoPlayTimeout) {
                clearTimeout(autoPlayTimeout);
            }

            let newIndex = current_index + step;
            let wrapped = false;

            if (newIndex >= total_count) {
                newIndex = 0;
                wrapped = true;
            } else if (newIndex < 0) {
                newIndex = total_count - 1;
                wrapped = true;
            }

            current_index = newIndex;

            // 1. æª¢æŸ¥æ˜¯å¦éœ€è¦è¼‰å…¥æ–°çš„æ‰¹æ¬¡
            const cacheIndex = current_index - currentBatchStart;
            const requiresNewBatch = cacheIndex < 0 || cacheIndex >= cardCache.length;
            
            if (requiresNewBatch) {
                // é€™è£¡æœƒé‡æ–°è¼‰å…¥ï¼Œä¸¦å¯èƒ½è§¸ç™¼æ–°çš„é é¢åˆ·æ–°é‚è¼¯ï¼Œä½†ç‚ºäº†ä¸ç ´å£æ‰¹æ¬¡é‚è¼¯ï¼Œæˆ‘å€‘è®“å®ƒç™¼é€ AJAX
                const newBatchStart = Math.floor(current_index / BATCH_SIZE) * BATCH_SIZE;
                await fetchAndCacheBatch(newBatchStart);
            }

            // 2. å¾ç·©å­˜ä¸­å–å‡ºå¡ç‰‡
            const card = cardCache[current_index - currentBatchStart];
            if (card) {
                // æ¸²æŸ“æ–°å¡ç‰‡ï¼Œä¸¦è‡ªå‹•æ’­æ”¾è²éŸ³ (true)
                renderCard(card, true);
            } else {
                renderCard({ term: 'è¼‰å…¥éŒ¯èª¤', part_of_speech: '', explanation: 'ç„¡æ³•å¾ç·©å­˜ä¸­è®€å–å¡ç‰‡ã€‚', example_sentence: '', type: 'error' });
                return;
            }

            // 3. å‘¼å«å¾Œç«¯ API æ›´æ–°é€²åº¦
            await fetch('{{ url_for("update_flashcard_index") }}', { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' }, 
                body: JSON.stringify({ index: current_index }) 
            });

            if (wrapped) {
                alert('æ­å–œï¼å·²ç¶“å®Œæˆä¸€è¼ªå­¸ç¿’ã€‚ç‰Œçµ„å°‡å¾ç¬¬ä¸€å¼µé–‹å§‹ã€‚');
            }
            
            // 4. ğŸš¨ ä¿®æ­£ Issue 1: è™•ç†è‡ªå‹•æ’­æ”¾ç‹€æ…‹
            if (sessionStorage.getItem(SESSION_KEY) === 'true') {
                // å¦‚æœæ˜¯è‡ªå‹•æ’­æ”¾æ¨¡å¼ï¼Œæˆ‘å€‘éœ€è¦é‡æ–°å•Ÿå‹•è¨ˆæ™‚å™¨ (å› ç‚º navigateCard å·²ç¶“åœæ­¢äº†å®ƒ)
                startAutoplaySequence();
            }
        }
        
        // =================================================================
        // ğŸš¨ æ ¸å¿ƒé‚è¼¯: è™•ç†ä¸‹ä¸€å¼µæŒ‰éˆ•é»æ“Š (å…ˆçœ‹ç­”æ¡ˆï¼Œå†è·³ä¸‹ä¸€å¼µ)
        // =================================================================
        async function handleNextClick() {
            if (!currentCardData || currentCardData.type === 'error') return;
            
            // 1. æª¢æŸ¥ç­”æ¡ˆæ˜¯å¦å·²å±•é–‹ (åˆ¤æ–·æ˜¯çœ‹ç­”æ¡ˆé‚„æ˜¯ä¸‹ä¸€å¼µ)
            const isAnswerShown = contentCollapse.classList.contains('show');

            if (!isAnswerShown) {
                // å‹•ä½œ 1: å±•é–‹ç­”æ¡ˆä¸¦æ’­æ”¾èªéŸ³
                stopAutoPlayLoop(false); // åœæ­¢è‡ªå‹•æ’­æ”¾ï¼Œä½†ä¸æ”¹è®ŠæŒ‰éˆ•æ–‡å­—
                window.speechSynthesis.cancel();
                
                // ä½¿ç”¨ Bootstrap JS ä¾†è§¸ç™¼é–‹åˆï¼Œç¢ºä¿æ¨£å¼æ­£ç¢º
                new bootstrap.Collapse(contentCollapse, { toggle: true });
                nextButton.textContent = 'ä¸‹ä¸€å¼µ â†’'; // è®Šæ›´æŒ‰éˆ•æ–‡å­—

                // å»¶é²æ’­æ”¾ï¼Œç¢ºä¿é–‹åˆå‹•ç•«å®Œæˆ
                setTimeout(() => {
                    speakFullAnswer(() => { /* èªéŸ³æ’­æ”¾å®Œç•¢ */ }); 
                }, 500);


            } else {
                // å‹•ä½œ 2: å°èˆªåˆ°ä¸‹ä¸€å¼µ
                await navigateCard(1); 
            }
        }


        // =================================================================
        // è‡ªå‹•æ’­æ”¾æ§åˆ¶
        // =================================================================
        
        /**
         * ğŸš¨ ä¿®æ­£ Issue 1: è‡ªå‹•æ’­æ”¾å•Ÿå‹•çš„æµç¨‹
         */
        function startAutoplaySequence() {
            if (sessionStorage.getItem(SESSION_KEY) !== 'true') return;
            
            // 1. å±•é–‹å¡ç‰‡
            if (!contentCollapse.classList.contains('show')) {
                // ä½¿ç”¨ Bootstrap JS ä¾†è§¸ç™¼é–‹åˆï¼Œç¢ºä¿æ¨£å¼æ­£ç¢º
                new bootstrap.Collapse(contentCollapse, { toggle: true });
            }

            nextButton.textContent = 'ä¸‹ä¸€å¼µ â†’'; // ç¢ºä¿æŒ‰éˆ•æ–‡å­—è®Šæ›´

            // 2. æ’­æ”¾èªéŸ³ï¼Œå®Œæˆå¾Œé€²å…¥è¨ˆæ™‚å™¨
            // å»¶é²æ’­æ”¾ï¼Œç¢ºä¿é–‹åˆå‹•ç•«å®Œæˆ
            setTimeout(() => {
                speakFullAnswer(() => {
                    autoPlayStep();
                });
            }, 500); 
        }

        /**
         * è™•ç†è‡ªå‹•æ’­æ”¾çš„è¨ˆæ™‚å’Œä¸‹ä¸€å¼µå°èˆªã€‚
         */
        function autoPlayStep() {
            if (sessionStorage.getItem(SESSION_KEY) !== 'true') return;
            if (autoPlayTimeout) clearTimeout(autoPlayTimeout);

            const intervalString = sessionStorage.getItem(INTERVAL_KEY);
            const interval = intervalString ? parseInt(intervalString) : 5000;

            // è¨­ç½®è¨ˆæ™‚å™¨ï¼Œç­‰å¾… interval æ™‚é–“å¾Œè·³è½‰åˆ°ä¸‹ä¸€å¼µ
            autoPlayTimeout = setTimeout(async () => {
                window.speechSynthesis.cancel();
                // å°èˆªè‡³ä¸‹ä¸€å¼µ (é€™æœƒè§¸ç™¼ navigateCardï¼Œç„¶å¾Œ navigateCard æœƒé‡æ–° call startAutoplaySequence)
                await navigateCard(1); 
            }, interval);
        }

        /**
         * åœæ­¢è‡ªå‹•æ’­æ”¾å¾ªç’°å’ŒèªéŸ³ã€‚
         * @param {boolean} updateButton - æ˜¯å¦æ›´æ–°æŒ‰éˆ•æ–‡å­—å’Œå•Ÿç”¨é–“éš”é¸æ“‡å™¨ã€‚
         */
        function stopAutoPlayLoop(updateButton = true) {
            if (autoPlayTimeout) {
                clearTimeout(autoPlayTimeout);
                autoPlayTimeout = null;
            }
            // ğŸš¨ ä¿®æ­£ Issue 3: ç¢ºä¿åœæ­¢æ‰€æœ‰èªéŸ³
            window.speechSynthesis.cancel(); 
            sessionStorage.removeItem(SESSION_KEY);

            if (intervalSelect) {
                intervalSelect.disabled = false;
            }

            if (updateButton) {
                playPauseBtn.innerHTML = 'â–¶ï¸ è‡ªå‹•æ’­æ”¾';
            }
        }

        function toggleAutoPlay() {
            const btn = document.getElementById('play-pause-btn');

            if (sessionStorage.getItem(SESSION_KEY) === 'true') {
                // æš«åœé‚è¼¯
                stopAutoPlayLoop();
                btn.innerHTML = 'â–¶ï¸ è‡ªå‹•æ’­æ”¾';
            } else {
                // é–‹å§‹é‚è¼¯
                window.speechSynthesis.cancel(); // ğŸš¨ é–‹å§‹å‰å…ˆåœæ­¢æ‰€æœ‰èªéŸ³

                const selectedInterval = intervalSelect.value;
                sessionStorage.setItem(INTERVAL_KEY, selectedInterval);

                sessionStorage.setItem(SESSION_KEY, 'true');
                btn.innerHTML = 'â¸ï¸ æš«åœ';

                intervalSelect.disabled = true;

                // ğŸš¨ ä¿®æ­£ Issue 1: ç«‹å³å•Ÿå‹•è‡ªå‹•æ’­æ”¾æµç¨‹
                startAutoplaySequence();
            }
        }


        // =================================================================
        // äº‹ä»¶ç›£è½å™¨èˆ‡åˆå§‹åŒ–
        // =================================================================

        // ğŸš¨ 1. é»æ“Š Term Line æˆ– Header æ™‚åˆ‡æ›ç­”æ¡ˆçš„é¡¯ç¤ºç‹€æ…‹ (æ‰‹å‹•é–‹åˆ)
        const manualToggleListener = (e) => {
            // é¿å…é»æ“ŠèªéŸ³æŒ‰éˆ•æˆ–ç¿»è­¯ä¾‹å¥æ™‚è§¸ç™¼é–‹åˆ
            if (e.target.classList.contains('tts-button') || e.target.id === 'card-example') {
                return;
            }
            
            stopAutoPlayLoop(false); // åœæ­¢è‡ªå‹•æ’­æ”¾ï¼Œä½†ä¸æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            window.speechSynthesis.cancel(); // ğŸš¨ åœæ­¢èªéŸ³

            // æª¢æŸ¥ç­”æ¡ˆæ˜¯å¦å³å°‡å±•é–‹ (å³ç›®å‰æ˜¯æ”¶åˆç‹€æ…‹)
            const willBeShown = !contentCollapse.classList.contains('show');
            if (willBeShown && currentCardData) {
                nextButton.textContent = 'ä¸‹ä¸€å¼µ â†’'; // è®Šæ›´æŒ‰éˆ•æ–‡å­—
                
                // å»¶é²æ’­æ”¾ï¼Œç¢ºä¿é–‹åˆå‹•ç•«å®Œæˆ
                setTimeout(() => {
                    speakFullAnswer(() => { /* æ‰‹å‹•ç¿»ç‰Œä¸éœ€å›èª¿ */ });
                }, 500);
            } else {
                nextButton.textContent = 'ä¸‹ä¸€å¼µ/çœ‹ç­”æ¡ˆ â†’';
            }
        };
        
        // ç¶å®šé»æ“Šäº‹ä»¶
        termLine.addEventListener('click', manualToggleListener);
        headerElement.addEventListener('click', manualToggleListener);


        document.addEventListener('DOMContentLoaded', async () => {
            // 1. åˆå§‹è¼‰å…¥ç¬¬ä¸€æ‰¹æ•¸æ“š
            if (cardCache.length === 0 && total_count > 0) {
                await fetchAndCacheBatch(currentBatchStart);
            }
            
            // 2. æ¸²æŸ“ç¬¬ä¸€å¼µå¡ç‰‡
            const initialCard = cardCache[current_index - currentBatchStart];
            if (initialCard) {
                renderCard(initialCard, false); // åˆå§‹è¼‰å…¥ä¸è‡ªå‹•æ’­æ”¾ term èªéŸ³

                // 3. ç¶å®šå€‹åˆ¥èªéŸ³æŒ‰éˆ•
                document.getElementById('term-tts-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    stopAutoPlayLoop(false);
                    if (currentCardData && currentCardData.term) {
                        speakText(currentCardData.term, 'ja-JP');
                    }
                });

                document.getElementById('example-tts-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    stopAutoPlayLoop(false);
                    if (currentCardData && currentCardData.example_sentence) {
                        speakText(currentCardData.example_sentence, 'ja-JP');
                    }
                });

                // 4. åˆå§‹åŒ–è‡ªå‹•æ’­æ”¾ç‹€æ…‹
                const storedInterval = sessionStorage.getItem(INTERVAL_KEY);
                if (storedInterval) {
                    intervalSelect.value = storedInterval;
                }

                if (sessionStorage.getItem(SESSION_KEY) === 'true') {
                    playPauseBtn.innerHTML = 'â¸ï¸ æš«åœ';
                    intervalSelect.disabled = true;
                    
                    // ğŸš¨ ä¿®æ­£ Issue 1: é é¢è¼‰å…¥æ™‚(åˆ‡åˆ°ä¸‹ä¸€å¼µæ™‚) ç«‹å³é–‹å§‹æ’­æ”¾
                    startAutoplaySequence(); 
                } else {
                    playPauseBtn.innerHTML = 'â–¶ï¸ è‡ªå‹•æ’­æ”¾';
                    intervalSelect.disabled = false;
                    // æ‰‹å‹•æ¨¡å¼ä¸‹ï¼Œåˆå§‹ç‹€æ…‹ç‚ºæ”¶åˆ
                    contentCollapse.classList.remove('show');
                }


            } else {
                termElement.textContent = 'æ¸…å–®ç‚ºç©ºï¼Œè«‹å›è¨­å®šé é‡æ–°è¼‰å…¥ã€‚';
            }
        });
    </script>
</body>

</html>