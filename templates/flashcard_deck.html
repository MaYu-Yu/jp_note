<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—å¡å­¸ç¿’</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* (CSS æ¨£å¼ä¿æŒä¸è®Šï¼Œç•¥) */
        body { background-color: #f8f9fa; }
        .flashcard-container {
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding-top: 5vh;
        }
        .flashcard {
            width: 95%;
            max-width: 900px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
        }
        .card-header-main {
            padding: 2rem;
            background-color: #d6eaff; 
            border-bottom: 2px solid #007bff;
            cursor: pointer;
            border-radius: 0.5rem 0.5rem 0 0;
            transition: background-color 0.3s;
        }
        .card-header-main:hover {
            background-color: #c1d9f4;
        }
        .term-text { 
            font-size: clamp(2.5em, 8vw, 4em);
            font-weight: bold; 
            color: #007bff; 
            margin-bottom: 0;
            display: inline;
        }
        #explanation-content {
            padding: 1.5rem 2rem;
            text-align: left; 
            transition: max-height 0.5s ease-out, opacity 0.3s ease-out;
            max-height: 0; 
            overflow: hidden;
            background-color: #fff;
            border-radius: 0 0 0.5rem 0.5rem;
            opacity: 0;
            visibility: hidden;
        }
        #explanation-content.show {
            max-height: 800px; 
            opacity: 1;
            visibility: visible;
        }
        .content-label {
            font-size: clamp(1.4em, 3.5vw, 1.8em); 
            font-weight: 500;
            margin-top: 1rem;
            margin-bottom: 0.3rem;
        }
        .content-text { 
            font-size: clamp(1.5em, 4vw, 2em); 
            line-height: 1.5;
            overflow-wrap: break-word; 
            word-break: break-word; 
            padding: 0.5rem 0;
        }
        .core-term-style { color: #d9534f; } 
        .explanation-style { color: #5cb85c; } 
        .example-style { color: #0275d8; font-style: italic; } 
        .sentence-link {
            text-decoration: none; 
            cursor: pointer;
            display: block;
            padding: 0.5rem 0;
            border: 1px dashed #ccc;
            border-radius: 5px;
            margin-top: 5px;
        }
        .sentence-link:hover {
            background-color: #f0f0f0;
        }
        /* æ–°å¢æ¨£å¼: è®“è·³è½‰è¼¸å…¥æ¡†å’ŒæŒ‰éˆ•ä¸¦æ’ */
        .jump-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
        }
        .jump-input {
            width: 100px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="flashcard-container">
        <a href="{{ url_for('flashcard_select') }}" class="btn btn-outline-secondary mb-4">â† é€€å‡ºå–®å­—å¡</a>
        
        <h3 class="mb-2">
            ç¬¬ <span id="current-display">{{ current_index + 1 }}</span> / {{ total_count }} ç­†
        </h3>
        <p class="text-muted mb-4 small">
            ç¯©é¸æ¢ä»¶: {{ filter_summary }}
        </p>

        <div class="flashcard card" id="flashcard">
            
            <div class="card-header-main" onclick="manualFlipAndSpeak()">
                <p class="term-text">
                    {{ card.term }}
                    {% if card.part_of_speech %}
                    <span class="badge bg-primary fs-5 align-text-bottom">{{ card.part_of_speech }}</span>
                    {% endif %}
                </p>
                <small class="text-muted mt-2 d-block">é»æ“Šé¡¯ç¤º/éš±è—è§£é‡‹åŠæ’­æ”¾èªéŸ³</small>
            </div>

            <div id="explanation-content" class="bg-white">
                
                <p class="content-label text-muted">æ—¥èª/æ ¸å¿ƒæ–‡æ³•:</p>
                <p class="content-text core-term-style" id="content-core-term"></p>
                <hr>

                <p class="content-label text-muted">è§£é‡‹/ä¸­æ–‡æ„æ€:</p>
                <p class="content-text explanation-style">{{ card.explanation }}</p>
                <hr>

                <p class="content-label text-muted">ä¾‹å¥ (é»æ“Šç¿»è­¯):</p>
                <a 
                    href="#" 
                    onclick="return openGoogleTranslate('{{ card.example_sentence | urlencode }}')" 
                    class="sentence-link" 
                    target="_blank"
                >
                    <p class="content-text example-style mb-0">{{ card.example_sentence }}</p>
                </a>
                
            </div>
            
        </div>

        <div class="w-100 mt-5 d-flex justify-content-center flex-column align-items-center">
            
            <div class="d-flex gap-3 mb-3">
                <button class="btn btn-warning btn-lg" onclick="navigateCard(-1)">â¬…ï¸ ä¸Šä¸€å€‹</button>
                <button class="btn btn-success btn-lg" id="play-pause-btn" onclick="toggleAutoPlay()">â–¶ï¸ è‡ªå‹•æ’­æ”¾</button>
                <button class="btn btn-warning btn-lg" onclick="navigateCard(1)">ä¸‹ä¸€å€‹ â¡ï¸</button>
            </div>
            
            <div class="d-flex align-items-center gap-3">
                <label for="interval-select" class="form-label mb-0">é–“éš” (ç§’):</label>
                <select class="form-select w-auto" id="interval-select">
                    <option value="1000">1</option>
                    <option value="2000">2</option>
                    <option value="3000">3</option>
                    <option value="4000">4</option>
                    <option value="5000" selected>5</option>
                    <option value="6000">6</option>
                    <option value="7000">7</option>
                    <option value="8000">8</option>
                </select>
                <button class="btn btn-info" onclick="speakCurrentCardManually()">ğŸ”Š é‡å”¸</button>
            </div>
            
            <hr class="w-75 my-3">
            
            <div class="jump-control">
                <label for="jump-to-input" class="form-label mb-0">è·³è½‰è‡³ç­†æ•¸:</label>
                <input 
                    type="number" 
                    id="jump-to-input" 
                    class="form-control jump-input" 
                    min="1" 
                    max="{{ total_count }}" 
                    value="{{ current_index + 1 }}"
                    aria-label="è·³è½‰ç­†æ•¸"
                >
                <button class="btn btn-primary" onclick="jumpToCard()">GO</button>
                <small class="text-muted">(1 - {{ total_count }})</small>
            </div>

        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const cardData = {{ card | tojson | safe }};
        const currentIndex = {{ current_index }};
        const totalCount = {{ total_count }};
        
        const SESSION_KEY = 'flashcard_autoplay_playing'; 
        const INTERVAL_KEY = 'flashcard_autoplay_interval';
        let autoPlayTimeout = null; 
        const contentElement = document.getElementById('explanation-content');
        const intervalSelect = document.getElementById('interval-select'); 
        
        const MAX_TTS_TIMEOUT = 15000; 

        // ------------------------------------------------------------------
        // ** è¼”åŠ©å‡½æ•¸å’ŒèªéŸ³åˆå§‹åŒ– (ä»£ç¢¼èˆ‡æ‚¨æä¾›çš„ç‰ˆæœ¬ä¸€è‡´ï¼Œæœªä¿®æ”¹) **
        // ------------------------------------------------------------------

        function extractCoreTerm(text) {
            if (!text) return '';
            const match = text.match(/\[([^\]]+)\]/);
            return match ? match[1].trim() : text.trim();
        }

        function createUtterance(text, lang = 'ja-JP') {
            if (!text) return null;
            let textToSpeak = text.trim();
            
            if (lang === 'ja-JP') {
                const match = textToSpeak.match(/\[([^\]]+)\]/);
                if (match && match[1]) {
                    textToSpeak = match[1].trim(); 
                } else {
                    textToSpeak = textToSpeak.split('+')[0].trim();
                }
            }

            if (textToSpeak) {
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = (lang === 'zh-TW') ? 'zh-TW' : 'ja-JP';
                return utterance;
            }
            return null;
        }

        function speakCurrentCard(onFinishCallback = null, includeChinese = true) {
            window.speechSynthesis.cancel(); 

            const utterances = [];
            utterances.push(createUtterance(cardData.term)); 

            if (includeChinese && cardData.explanation) {
                 utterances.push(createUtterance(cardData.explanation, 'zh-TW')); 
            }
            
            utterances.push(createUtterance(cardData.example_sentence)); 

            const finalUtterances = utterances.filter(u => u !== null);

            if (finalUtterances.length === 0) {
                if (onFinishCallback) onFinishCallback();
                return;
            }
            
            let ttsFallback = null;

            if (onFinishCallback) {
                ttsFallback = setTimeout(() => {
                    console.warn("TTS fallback executed: Forcing onFinishCallback.");
                    window.speechSynthesis.cancel();
                    onFinishCallback();
                }, MAX_TTS_TIMEOUT); 
            }

            function queueUtterances(index) {
                if (index >= finalUtterances.length) {
                    if (ttsFallback) clearTimeout(ttsFallback); 
                    if (onFinishCallback) onFinishCallback();
                    return;
                }
                
                const currentUtterance = finalUtterances[index];
                
                currentUtterance.onend = () => {
                    queueUtterances(index + 1);
                };
                
                currentUtterance.onerror = (event) => {
                    console.error("TTS Error:", event.error);
                    queueUtterances(index + 1); 
                };

                window.speechSynthesis.speak(currentUtterance);
            }
            
            queueUtterances(0);
        }

        function stopAutoPlayLoop(updateButton = true) {
             if (autoPlayTimeout) {
                clearTimeout(autoPlayTimeout);
                autoPlayTimeout = null;
             }
             window.speechSynthesis.cancel(); 
             sessionStorage.removeItem(SESSION_KEY);
             sessionStorage.removeItem(INTERVAL_KEY); 
             
             if (intervalSelect) {
                 intervalSelect.disabled = false;
             }

             if (updateButton) {
                document.getElementById('play-pause-btn').innerHTML = 'â–¶ï¸ è‡ªå‹•æ’­æ”¾';
             }
             console.log("Auto-play loop stopped by user action.");
        }


        // ------------------------------------------------------------------
        // ** DOMContentLoaded è™•ç† (é é¢è¼‰å…¥æ™‚) **
        // ------------------------------------------------------------------

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('content-core-term').textContent = extractCoreTerm(cardData.term);

            const savedInterval = sessionStorage.getItem(INTERVAL_KEY);
            if (savedInterval) {
                 intervalSelect.value = savedInterval;
            }

            if (sessionStorage.getItem(SESSION_KEY) === 'true') {
                const btn = document.getElementById('play-pause-btn');
                btn.innerHTML = 'â¸ï¸ æš«åœ';
                autoPlayStep(); 
                
                if (intervalSelect) {
                    intervalSelect.disabled = true;
                }
            }
        });
        
        // --- ç¿»è­¯é€£çµå‡½æ•¸ ---
        
        function openGoogleTranslate(encodedText) {
            stopAutoPlayLoop(false); 
            
            const url = `https://translate.google.com/?sl=ja&tl=zh-TW&text=${encodedText}&op=translate`;
            window.open(url, '_blank');
            return false; 
        }
        
        // --- å°èˆªèˆ‡æ‰‹å‹•æ“ä½œå‡½æ•¸ ---

        async function updateIndexMemory(index) {
            try {
                // ğŸš¨ é€™è£¡ä½¿ç”¨ update_flashcard_index è·¯ç”±
                const response = await fetch("{{ url_for('update_flashcard_index') }}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ index: index })
                });
                return await response.json();
            } catch (error) {
                console.error('Error updating index:', error);
                return { success: false };
            }
        }
        
        /**
         * è™•ç†å‰å¾Œå°èˆªæˆ–è‡ªå‹•å°èˆª
         * @param {number} direction - 1 (ä¸‹ä¸€å€‹) æˆ– -1 (ä¸Šä¸€å€‹)
         */
        async function navigateCard(direction) {
            
            if (sessionStorage.getItem(SESSION_KEY) !== 'true') {
                 stopAutoPlayLoop(); 
            } else {
                if (autoPlayTimeout) clearTimeout(autoPlayTimeout);
                window.speechSynthesis.cancel(); 
            }


            const isNext = direction === 1;
            const isContentHidden = !contentElement.classList.contains('show');

            if (isNext && isContentHidden && sessionStorage.getItem(SESSION_KEY) !== 'true') {
                contentElement.classList.add('show');
                speakCurrentCard(() => {}, true); 
                return; 
            }
            
            let nextIndex = currentIndex + direction;

            if (nextIndex >= totalCount) {
                nextIndex = 0; 
            } else if (nextIndex < 0) {
                nextIndex = totalCount - 1; 
            }

            // ** å°èˆªè‡³æ–°ç´¢å¼• **
            await navigateToNewIndex(nextIndex);
        }
        
        /**
         * è™•ç†è·³è½‰è‡³æŒ‡å®šç­†æ•¸
         */
        async function jumpToCard() {
             // **ä½¿ç”¨è€…è¡Œç‚ºï¼šå¼·åˆ¶åœæ­¢è‡ªå‹•æ’­æ”¾**
            stopAutoPlayLoop(); 
            
            const jumpInput = document.getElementById('jump-to-input');
            const target = parseInt(jumpInput.value);
            
            if (isNaN(target) || target < 1 || target > totalCount) {
                alert(`è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„ç­†æ•¸ (1 åˆ° ${totalCount})ã€‚`);
                jumpInput.value = currentIndex + 1; // é‡ç½®å›ç•¶å‰ç­†æ•¸
                return;
            }
            
            // å°‡ç­†æ•¸è½‰æ›ç‚ºç¨‹å¼ç¢¼ä¸­çš„ 0-based ç´¢å¼•
            const targetIndex = target - 1; 

            // ** è·³è½‰è‡³æ–°ç´¢å¼• **
            await navigateToNewIndex(targetIndex);
        }
        
        /**
         * é€šç”¨è·³è½‰å‡½å¼ï¼šæ›´æ–°ç´¢å¼•ä¸¦é‡æ–°è¼‰å…¥é é¢
         * @param {number} newIndex - æ–°çš„ 0-based ç´¢å¼•
         */
        async function navigateToNewIndex(newIndex) {
            // 1. æ›´æ–°å¾Œç«¯ Session ä¸­çš„ç´¢å¼•
            await updateIndexMemory(newIndex); 
            // 2. é‡æ–°è¼‰å…¥é é¢ï¼ŒFlask æœƒå¾ Session ä¸­è®€å–æ–°ç´¢å¼•
            window.location.href = `{{ url_for('flashcard_deck', action='resume') }}`;
        }

        function manualFlipAndSpeak() {
            stopAutoPlayLoop(); 
            
            if (contentElement.classList.contains('show')) {
                 window.speechSynthesis.cancel(); 
                 contentElement.classList.remove('show');
            } else {
                 contentElement.classList.add('show'); 
                 speakCurrentCard(() => {}, true); 
            }
        }
        
        function speakCurrentCardManually() {
            stopAutoPlayLoop();
            contentElement.classList.add('show');
            speakCurrentCard(() => {}, true);
        }


        // --- è‡ªå‹•æ’­æ”¾æ§åˆ¶ ---

        function autoPlayStep() {
            if (sessionStorage.getItem(SESSION_KEY) !== 'true') return; 
            if (autoPlayTimeout) clearTimeout(autoPlayTimeout);
            
            const intervalString = sessionStorage.getItem(INTERVAL_KEY);
            const interval = intervalString ? parseInt(intervalString) : 5000;
            
            setTimeout(() => {
                
                if (sessionStorage.getItem(SESSION_KEY) !== 'true') return; 
                contentElement.classList.add('show');
                
                speakCurrentCard(() => {
                    
                    if (sessionStorage.getItem(SESSION_KEY) !== 'true') return; 

                    autoPlayTimeout = setTimeout(async () => {
                         window.speechSynthesis.cancel();
                         contentElement.classList.remove('show'); 
                         await navigateCard(1); 
                    }, interval); 
                }, true); 

            }, 500); 
        }

        function toggleAutoPlay() {
            const btn = document.getElementById('play-pause-btn');
            
            if (sessionStorage.getItem(SESSION_KEY) === 'true') {
                // æš«åœé‚è¼¯
                stopAutoPlayLoop(); 
                btn.innerHTML = 'â–¶ï¸ è‡ªå‹•æ’­æ”¾';
            } else {
                // é–‹å§‹é‚è¼¯
                
                const selectedInterval = intervalSelect.value;
                sessionStorage.setItem(INTERVAL_KEY, selectedInterval);

                sessionStorage.setItem(SESSION_KEY, 'true'); 
                btn.innerHTML = 'â¸ï¸ æš«åœ';
                
                intervalSelect.disabled = true;

                if (contentElement.classList.contains('show')) {
                    contentElement.classList.remove('show');
                }
                autoPlayStep(); 
            }
        }

    </script>
</body>
</html>