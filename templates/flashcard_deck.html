<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—å¡å­¸ç¿’</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .flashcard-container {
            min-height: 80vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding-top: 5vh;
        }

        .flashcard {
            width: 95%;
            max-width: 900px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-radius: 0.5rem;
            min-height: 450px;
            display: flex;
            flex-direction: column;
        }

        .card-header-main {
            padding: 1.5rem 2rem;
            background-color: #d6eaff;
            border-bottom: 2px solid #007bff;
            border-radius: 0.5rem 0.5rem 0 0;
            font-size: 1.2rem;
            color: #007bff;
            font-weight: bold;
            cursor: pointer;
        }

        .card-body {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 2rem;
            text-align: center;
        }

        /* ç¬¬ä¸€è¡Œ: æ—¥èªã€è©æ€§ã€èªéŸ³ */
        .term-text {
            font-size: 3rem;
            font-weight: bold;
            color: #007bff;
            margin: 0;
            line-height: 1.3;
            word-break: break-word;
            text-align: left;
        }

        .term-line {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #ddd;
            padding-bottom: 1.5rem;
            cursor: pointer;
            min-height: 100px;
        }

        .explanation-line,
        .example-line {
            text-align: left;
        }

        /* èª¿æ•´å¾½ç« å’ŒæŒ‰éˆ•åœ¨ Term æ—é‚Šçš„ä½ç½® */
        .pos-badge,
        .tts-button {
            margin-left: 10px;
        }

        .pos-badge {
            font-size: 1.2rem;
        }

        .tts-button {
            cursor: pointer;
            color: #28a745;
            font-size: 1.5em;
            vertical-align: top;
            transition: color 0.2s;
        }

        .tts-button:hover {
            color: #1e7e34;
        }

        .explanation-line {
            margin-bottom: 1.5rem;
        }

        .content-label {
            font-weight: bold;
            color: #6c757d;
            margin-bottom: 0.25rem;
            font-size: 1.1rem;
            text-align: left;
        }

        .content-text {
            margin-bottom: 1rem;
            font-size: 1.1rem;
            line-height: 1.6;
            text-align: left;
        }

        .explanation-style {
            color: #343a40;
            padding: 10px;
            background-color: #e9f5ff;
            border-left: 4px solid #007bff;
            border-radius: 4px;
        }

        .example-style {
            color: #343a40;
            padding: 10px;
            background-color: #f7f7f7;
            border-left: 4px solid #28a745;
            border-radius: 4px;
            cursor: pointer;
        }

        /* å¡ç‰‡å…§éƒ¨å°èˆªæŒ‰éˆ•ä½ˆå±€ */
        .control-row-nav-internal {
            display: flex;
            width: 100%;
            justify-content: space-between;
            gap: 15px;
            padding-top: 1rem;
            border-top: 1px solid #ddd;
            margin-top: auto;
        }

        .control-row-nav-internal .btn-lg {
            flex-grow: 1;
            max-width: 48%;
        }

        /* å¤–éƒ¨æ§åˆ¶é …ï¼šä½ˆå±€èª¿æ•´ï¼šå¡ç‰‡ä¸‹æ–¹çš„æŒ‰éˆ•ç¾¤çµ„ */
        .control-row-main {
            width: 95%;
            max-width: 900px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        /* é‡è¤‡ä½¿ç”¨åŸæœ‰çš„å±…ä¸­ç¾¤çµ„æ¨£å¼ */
        .control-row-center {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
        }

        .autoplay-controls .form-select {
            width: 100px;
        }

        /* è®“ collapse å…§å®¹ä¸æœƒè¢« flex å®¹å™¨å£“ç¸® */
        .collapse:not(.show) {
            flex-shrink: 0;
        }
    </style>
</head>

<body>
    <div class="container flashcard-container">
        <div class="row w-100 justify-content-center">
            <div class="col-12 col-lg-10">
                <div class="card flashcard shadow">
                    <div class="card-header card-header-main" id="flashcard-header" data-bs-toggle="collapse"
                        data-bs-target="#explanation-content" aria-expanded="false" aria-controls="explanation-content">
                        å–®å­—å¡ç‰Œçµ„ï¼š{{ filter_summary }}
                    </div>

                    <div class="card-body">
                        <div>
                            <div class="text-center mb-4">
                                <span id="current-index-display" class="h5 text-dark fw-bold me-3">
                                    è¼‰å…¥ä¸­...
                                </span>
                            </div>

                            <div class="term-line" id="term-line-clickable" data-bs-toggle="collapse"
                                data-bs-target="#explanation-content" aria-expanded="false"
                                aria-controls="explanation-content">
                                <h2 class="term-text" id="card-term">
                                </h2>
                                <span id="card-pos" class="pos-badge badge bg-primary">
                                </span>
                                <span class="tts-button" id="term-tts-btn">ğŸ”Š</span>
                                <span id="card-type-info" class="ms-auto text-secondary small"></span>
                            </div>

                            <div class="collapse" id="explanation-content">
                                <div class="explanation-line">
                                    <p class="content-label">è§£é‡‹/ä¸­æ–‡æ„æ€:</p>
                                    <p class="content-text explanation-style" id="card-explanation">
                                    </p>
                                </div>

                                <div class="example-line">
                                    <p class="content-label">ä¾‹å¥ (é»æ“Šå¯ç¿»è­¯):
                                        <span class="tts-button" id="example-tts-btn">ğŸ”Š</span>
                                    </p>
                                    <p class="content-text example-style" id="card-example"
                                        onclick="openGoogleTranslate(currentCardData.example_sentence)">
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="control-row-nav-internal">
                            <button id="prev-btn" class="btn btn-warning btn-lg" onclick="navigateCard(-1)">â†
                                ä¸Šä¸€å¼µ</button>
                            <button id="next-btn" class="btn btn-success btn-lg" onclick="handleNextClick()">ä¸‹ä¸€å¼µ/çœ‹ç­”æ¡ˆ
                                â†’</button>
                        </div>

                    </div>
                </div>
                <div class="control-row-main mt-4">

                    <div class="control-row-center">
                        <button onclick="history.back()" class="btn btn-secondary">â† è¿”å›ä¸Šé </button>
                        <a href="{{ url_for('home') }}" class="btn btn-secondary">ğŸ  è¿”å›é¦–é </a>
                        <div class="autoplay-controls d-flex flex-nowrap align-items-center">
                            <select id="interval-select" class="form-select w-auto me-2">
                                <option value="1000">1 ç§’</option>
                                <option value="2000">2 ç§’</option>
                                <option value="3000">3 ç§’</option>
                                <option value="4000">4 ç§’</option>
                                <option value="5000" selected>5 ç§’</option>
                                <option value="6000">6 ç§’</option>
                                <option value="7000">7 ç§’</option>
                                <option value="8000">8 ç§’</option>
                                <option value="9000">9 ç§’</option>
                                <option value="10000">10 ç§’</option>
                            </select>
                            <button id="play-pause-btn" class="btn btn-primary" onclick="toggleAutoPlay()">â–¶ï¸
                                è‡ªå‹•æ’­æ”¾</button>
                        </div>

                        <button id="replay-btn" class="btn btn-info" onclick="speakFullAnswerWithCancel()">ğŸ”Š
                            é‡å”¸ç­”æ¡ˆ</button>

                    </div>

                    <div class="control-row-center mt-3">
                        <label for="jump-to-input" class="form-label mb-0 fw-bold">è·³è½‰è‡³ç­†æ•¸:</label>
                        <input type="number" id="jump-to-input" class="form-control"
                            style="width: 100px; text-align: center;" min="1" max="{{ total_count }}"
                            value="{{ current_index + 1 }}" aria-label="è·³è½‰ç­†æ•¸">
                        <button class="btn btn-primary" onclick="jumpToCard()">GO</button>
                        <small class="text-muted">(1 - {{ total_count }})</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // =================================================================
        // æ ¸å¿ƒè®Šæ•¸å’Œå…ƒç´ å®šç¾©
        // =================================================================
        const BATCH_SIZE = 20;
        let current_index = {{ current_index }};
        const total_count = {{ total_count }};
        let currentCardData = null; // å¾ä¼ºæœå™¨è¼‰å…¥çš„ç•¶å‰å¡ç‰‡æ•¸æ“š

        let cardCache = [];
        let currentBatchStart = 0;

        // å…ƒç´ é¸æ“‡å™¨
        const indexDisplay = document.getElementById('current-index-display');
        const termElement = document.getElementById('card-term');
        const posElement = document.getElementById('card-pos');
        const explanationElement = document.getElementById('card-explanation');
        const exampleElement = document.getElementById('card-example');
        const contentCollapse = document.getElementById('explanation-content');
        const typeInfoElement = document.getElementById('card-type-info');
        const termLine = document.getElementById('term-line-clickable');
        const headerElement = document.getElementById('flashcard-header');
        const nextButton = document.getElementById('next-btn');
        const jumpInput = document.getElementById('jump-to-input');

        const intervalSelect = document.getElementById('interval-select');
        const playPauseBtn = document.getElementById('play-pause-btn');

        // è‡ªå‹•æ’­æ”¾ç›¸é—œè®Šæ•¸
        const SESSION_KEY = 'flashcard_autoplay_enabled';
        const INTERVAL_KEY = 'flashcard_autoplay_interval';
        let autoPlayTimeout = null;
        let isSpeaking = false;


        // =================================================================
        // è¼”åŠ©å‡½æ•¸å’ŒèªéŸ³åˆæˆ (TTS) é‚è¼¯
        // =================================================================

        /**
         * åœæ­¢è‡ªå‹•æ’­æ”¾å¾ªç’°å’ŒèªéŸ³ã€‚
         * @param {boolean} updateButton - æ˜¯å¦æ›´æ–°æŒ‰éˆ•æ–‡å­—å’Œå•Ÿç”¨é–“éš”é¸æ“‡å™¨ã€‚
         */
        function stopAutoPlayLoop(updateButton = true) {
            if (autoPlayTimeout) {
                clearTimeout(autoPlayTimeout);
                autoPlayTimeout = null;
            }
            // ç¢ºä¿åœæ­¢æ‰€æœ‰èªéŸ³
            window.speechSynthesis.cancel();
            sessionStorage.removeItem(SESSION_KEY);

            if (intervalSelect) {
                intervalSelect.disabled = false;
            }

            if (updateButton) {
                playPauseBtn.innerHTML = 'â–¶ï¸ è‡ªå‹•æ’­æ”¾';
            }
        }


        /**
         * åŸ·è¡ŒèªéŸ³æ’­æ”¾ã€‚
         */
        function speakText(text, lang, callback = () => { }) {
            if (!('speechSynthesis' in window) || !text || text.trim() === '') {
                callback();
                return;
            }

            let textToSpeak = text.trim();

            // è™•ç†æ—¥èªæ–‡æœ¬ï¼Œåªè®€å–ä¸»è¦å–®å­—/æ–‡æ³•ï¼Œå¿½ç•¥ + è™Ÿå¾Œçš„è³‡è¨Š
            if (lang === 'ja-JP') {
                const match = textToSpeak.match(/\[([^\]]+)\]/);
                if (match && match[1]) {
                    textToSpeak = match[1].trim();
                } else {
                    textToSpeak = textToSpeak.split('+')[0].trim();
                }
            }

            if (textToSpeak) {
                const utterance = new SpeechSynthesisUtterance(textToSpeak);
                utterance.lang = (lang === 'zh-TW') ? 'zh-TW' : 'ja-JP';
                utterance.rate = 1.0;

                utterance.onend = () => {
                    isSpeaking = false;
                    callback();
                };

                utterance.onerror = (e) => {
                    console.error('TTS Error:', e);
                    isSpeaking = false;
                    callback();
                };

                isSpeaking = true;
                window.speechSynthesis.speak(utterance);
            } else {
                callback();
            }
        }

        /**
         * æ ¸å¿ƒTTSå‡½æ•¸ï¼šä¾åºæ’­æ”¾æ—¥èª Term, ä¸­æ–‡è§£é‡‹, æ—¥èªä¾‹å¥
         */
        function speakFullAnswer(callback = () => { }) {
            if (!currentCardData || currentCardData.type === 'error') {
                callback();
                return;
            }

            // 1. æ’­æ”¾æ—¥èª Term
            speakText(currentCardData.term, 'ja-JP', () => {
                // 2. æ’­æ”¾ä¸­æ–‡è§£é‡‹
                const explanationText = explanationElement.textContent;
                speakText(explanationText, 'zh-TW', () => {
                    // 3. æ’­æ”¾æ—¥èªä¾‹å¥
                    const exampleText = exampleElement.textContent;
                    speakText(exampleText, 'ja-JP', () => {
                        // 4. å…¨éƒ¨å®Œæˆ
                        callback();
                    });
                });
            });
        }

        /**
         * ä¾›ã€Œé‡å”¸ç­”æ¡ˆã€æŒ‰éˆ•ä½¿ç”¨çš„å‡½æ•¸ (ç«‹å³ä¸­æ–·ä¸¦é‡å”¸ç­”æ¡ˆ)
         */
        function speakFullAnswerWithCancel() {
            stopAutoPlayLoop(true); // åœæ­¢è‡ªå‹•æ’­æ”¾ (è£¡é¢æœƒå‘¼å« cancel())

            // ç¢ºä¿ç­”æ¡ˆå±•é–‹
            if (!contentCollapse.classList.contains('show')) {
                new bootstrap.Collapse(contentCollapse, { toggle: true });
            }

            nextButton.textContent = 'ä¸‹ä¸€å¼µ â†’';

            setTimeout(() => {
                // ğŸš¨ ä¿®æ­£é»ï¼šåœ¨é–‹å§‹æ’­æ”¾å‰å†æ¬¡å¼·åˆ¶å–æ¶ˆï¼Œç¢ºä¿ä¸­æ–·æ­£åœ¨æ’­æ”¾æˆ–å°šæœªé–‹å§‹çš„èªéŸ³ã€‚
                window.speechSynthesis.cancel();
                speakFullAnswer(() => { /* do nothing */ });
            }, 500);
        }

        /**
         * ç¿»è­¯å‰åœæ­¢è‡ªå‹•æ’­æ”¾
         */
        function openGoogleTranslate(text) {
            stopAutoPlayLoop(true);
            window.speechSynthesis.cancel();
            const encodedText = encodeURIComponent(text);
            const url = `https://translate.google.com/?sl=ja&tl=zh-TW&text=${encodedText}&op=translate`;
            window.open(url, '_blank');
            return false;
        }

        // =================================================================
        // AJAX æ‰¹æ¬¡è¼‰å…¥å’Œå°èˆª
        // =================================================================

        async function fetchAndCacheBatch(startIndex) {
            if (startIndex >= total_count) {
                cardCache = [];
                currentBatchStart = total_count;
                return;
            }
            termElement.textContent = 'â³ è¼‰å…¥ä¸‹ä¸€æ‰¹å¡ç‰‡...';
            posElement.style.display = 'none';
            typeInfoElement.textContent = '';
            explanationElement.textContent = '';
            exampleElement.textContent = '';
            contentCollapse.classList.remove('show');
            nextButton.textContent = 'ä¸‹ä¸€å¼µ/çœ‹ç­”æ¡ˆ â†’';
            try {
                const response = await fetch(`/api/get_flashcard/${startIndex}`);
                const result = await response.json();
                if (result.success) {
                    cardCache = result.cards;
                    currentBatchStart = startIndex;
                } else {
                    cardCache = [];
                    currentBatchStart = startIndex;
                }
            } catch (error) {
                cardCache = [];
                currentBatchStart = startIndex;
            }
        }

        function renderCard(card, autoSpeak = false) {
            currentCardData = card;
            indexDisplay.textContent = `ç¬¬ ${current_index + 1} / ${total_count} ç­†`;
            jumpInput.value = current_index + 1;

            termElement.innerHTML = card.term ? card.term.replace(/\|/g, '<br>') : 'N/A';
            posElement.textContent = card.part_of_speech || '';
            posElement.style.display = card.part_of_speech ? 'inline-block' : 'none';

            explanationElement.innerHTML = card.explanation ? card.explanation.replace(/\n/g, '<br>') : 'N/A';
            exampleElement.innerHTML = card.example_sentence ? card.example_sentence.replace(/\n/g, '<br>') : 'N/A';

            typeInfoElement.textContent = card.type === 'vocab' ? 'å–®å­—' : (card.type === 'grammar' ? 'æ–‡æ³•' : '');

            contentCollapse.classList.remove('show');
            nextButton.textContent = 'ä¸‹ä¸€å¼µ/çœ‹ç­”æ¡ˆ â†’';

            if (autoSpeak) {
                // é€™è£¡åªè®€ Term
                window.speechSynthesis.cancel();
                speakText(card.term, 'ja-JP');
            }
        }

        /**
         * è™•ç†è·³è½‰èˆ‡å°èˆªçš„æ ¸å¿ƒå‡½æ•¸
         * @param {number} newIndex - ç›®æ¨™ç´¢å¼• (å¾ 0 é–‹å§‹)
         */
        async function navigateToNewIndex(newIndex) {
            // 1. æª¢æŸ¥æ˜¯å¦éœ€è¦è¼‰å…¥æ–°çš„æ‰¹æ¬¡
            const cacheIndex = newIndex - currentBatchStart;
            const requiresNewBatch = cacheIndex < 0 || cacheIndex >= cardCache.length;

            if (requiresNewBatch) {
                const newBatchStart = Math.floor(newIndex / BATCH_SIZE) * BATCH_SIZE;
                await fetchAndCacheBatch(newBatchStart);
            }

            current_index = newIndex;

            // 2. å¾ç·©å­˜ä¸­å–å‡ºå¡ç‰‡
            const card = cardCache[current_index - currentBatchStart];
            if (card) {
                renderCard(card, true); // æ¸²æŸ“æ–°å¡ç‰‡ï¼Œä¸¦è‡ªå‹•æ’­æ”¾èªéŸ³
            } else {
                renderCard({ term: 'è¼‰å…¥éŒ¯èª¤', part_of_speech: '', explanation: 'ç„¡æ³•å¾ç·©å­˜ä¸­è®€å–å¡ç‰‡ã€‚', example_sentence: '', type: 'error' });
                return;
            }

            // 3. å‘¼å«å¾Œç«¯ API æ›´æ–°é€²åº¦
            const response = await fetch('{{ url_for("update_flashcard_index") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index: current_index })
            });

            const result = await response.json();

            // 4. è™•ç†å¾ªç’°
            if (result.wrapped) {
                alert('æ­å–œï¼å·²ç¶“å®Œæˆä¸€è¼ªå­¸ç¿’ã€‚ç‰Œçµ„å°‡å¾ç¬¬ä¸€å¼µé–‹å§‹ã€‚');
            }

            // 5. è™•ç†è‡ªå‹•æ’­æ”¾ç‹€æ…‹
            if (sessionStorage.getItem(SESSION_KEY) === 'true') {
                startAutoplaySequence();
            }
        }


        /**
         * è™•ç†å‰å¾Œå°èˆª
         * @param {number} step - 1 (ä¸‹ä¸€å€‹) æˆ– -1 (ä¸Šä¸€å€‹)
         */
        async function navigateCard(step) {
            if (total_count === 0) return;

            stopAutoPlayLoop(true); // å°èˆªå‰åœæ­¢è‡ªå‹•æ’­æ”¾

            let newIndex = current_index + step;

            if (newIndex >= total_count) {
                newIndex = 0;
            } else if (newIndex < 0) {
                newIndex = total_count - 1;
            }

            await navigateToNewIndex(newIndex);
        }

        /**
         * è·³è½‰è‡³æŒ‡å®šç­†æ•¸
         */
        async function jumpToCard() {
            stopAutoPlayLoop(true);
            window.speechSynthesis.cancel();

            const target = parseInt(jumpInput.value);

            if (isNaN(target) || target < 1 || target > total_count) {
                alert(`è«‹è¼¸å…¥ä¸€å€‹æœ‰æ•ˆçš„ç­†æ•¸ (1 åˆ° ${total_count})ã€‚`);
                jumpInput.value = current_index + 1;
                return;
            }

            const targetIndex = target - 1;

            if (targetIndex === current_index) {
                alert('å·²åœ¨ç›®æ¨™å¡ç‰‡ä¸Šã€‚');
                return;
            }

            await navigateToNewIndex(targetIndex);
        }


        // =================================================================
        // æ‰‹å‹•æ“ä½œå’Œè‡ªå‹•æ’­æ”¾æ§åˆ¶
        // =================================================================

        /**
         * è™•ç†ä¸‹ä¸€å¼µæŒ‰éˆ•é»æ“Š (å…ˆçœ‹ç­”æ¡ˆï¼Œå†è·³ä¸‹ä¸€å¼µ)
         */
        async function handleNextClick() {
            if (!currentCardData || currentCardData.type === 'error') return;

            const isAnswerShown = contentCollapse.classList.contains('show');

            if (!isAnswerShown) {
                // å‹•ä½œ 1: å±•é–‹ç­”æ¡ˆä¸¦æ’­æ”¾èªéŸ³
                stopAutoPlayLoop(true); // åœæ­¢è‡ªå‹•æ’­æ”¾
                window.speechSynthesis.cancel();

                new bootstrap.Collapse(contentCollapse, { toggle: true });
                nextButton.textContent = 'ä¸‹ä¸€å¼µ â†’';

                setTimeout(() => {
                    // æ’­æ”¾å‰å†æ¬¡å–æ¶ˆï¼Œé˜²æ­¢è‡ªå‹•æ’­æ”¾çš„èªéŸ³åºåˆ—è¢«å»¶é²å•Ÿå‹•
                    window.speechSynthesis.cancel();
                    // æ’­æ”¾å®Œæ•´ç­”æ¡ˆï¼Œä¸å¸¶å›èª¿ (ä¸æœƒå•Ÿå‹•è¨ˆæ™‚å™¨)
                    speakFullAnswer(() => { /* do nothing */ });
                }, 500);

            } else {
                // å‹•ä½œ 2: å°èˆªåˆ°ä¸‹ä¸€å¼µ 
                await navigateCard(1);
            }
        }


        /**
         * è‡ªå‹•æ’­æ”¾å•Ÿå‹•çš„æµç¨‹
         */
        function startAutoplaySequence() {
            if (sessionStorage.getItem(SESSION_KEY) !== 'true') return;

            if (!contentCollapse.classList.contains('show')) {
                new bootstrap.Collapse(contentCollapse, { toggle: true });
            }

            nextButton.textContent = 'ä¸‹ä¸€å¼µ â†’';

            setTimeout(() => {
                // æ’­æ”¾å‰å†æ¬¡å–æ¶ˆï¼Œç¢ºä¿èªéŸ³ç¨ç«‹
                window.speechSynthesis.cancel();
                // æ’­æ”¾å®Œæ•´ç­”æ¡ˆï¼Œå®Œæˆå¾Œé€²å…¥è¨ˆæ™‚å™¨
                speakFullAnswer(() => {
                    autoPlayStep();
                });
            }, 500);
        }

        /**
         * è™•ç†è‡ªå‹•æ’­æ”¾çš„è¨ˆæ™‚å’Œä¸‹ä¸€å¼µå°èˆªã€‚
         */
        function autoPlayStep() {
            if (sessionStorage.getItem(SESSION_KEY) !== 'true') return;
            if (autoPlayTimeout) clearTimeout(autoPlayTimeout);

            const intervalString = sessionStorage.getItem(INTERVAL_KEY);
            const interval = intervalString ? parseInt(intervalString) : 5000;

            autoPlayTimeout = setTimeout(async () => {
                window.speechSynthesis.cancel();
                // é€™è£¡æˆ‘å€‘ç›´æ¥å°èˆªåˆ°ä¸‹ä¸€å¼µï¼Œè®“ navigateToNewIndex è™•ç†å¾ŒçºŒçš„è‡ªå‹•æ’­æ”¾å•Ÿå‹•
                await navigateToNewIndex((current_index + 1) % total_count);
            }, interval);
        }

        function toggleAutoPlay() {
            const btn = document.getElementById('play-pause-btn');

            if (sessionStorage.getItem(SESSION_KEY) === 'true') {
                // æš«åœé‚è¼¯
                stopAutoPlayLoop(true); // ç¢ºä¿åœæ­¢
            } else {
                // é–‹å§‹é‚è¼¯
                window.speechSynthesis.cancel();

                const selectedInterval = intervalSelect.value;
                sessionStorage.setItem(INTERVAL_KEY, selectedInterval);

                sessionStorage.setItem(SESSION_KEY, 'true');
                btn.innerHTML = 'â¸ï¸ æš«åœ';

                intervalSelect.disabled = true;

                startAutoplaySequence();
            }
        }


        // =================================================================
        // äº‹ä»¶ç›£è½å™¨èˆ‡åˆå§‹åŒ–
        // =================================================================

        // é»æ“Š Term Line æˆ– Header æ™‚ç«‹å³åœæ­¢è‡ªå‹•æ’­æ”¾
        const manualToggleListener = (e) => {
            // é¿å…é»æ“ŠèªéŸ³æŒ‰éˆ•æˆ–ç¿»è­¯ä¾‹å¥æ™‚è§¸ç™¼é–‹åˆ
            if (e.target.classList.contains('tts-button') || e.target.id === 'card-example') {
                return;
            }

            stopAutoPlayLoop(true); // åœæ­¢è‡ªå‹•æ’­æ”¾
            window.speechSynthesis.cancel();

            // æª¢æŸ¥ç­”æ¡ˆæ˜¯å¦å³å°‡å±•é–‹ (å³ç›®å‰æ˜¯æ”¶åˆç‹€æ…‹)
            const willBeShown = !contentCollapse.classList.contains('show');
            if (willBeShown && currentCardData) {
                nextButton.textContent = 'ä¸‹ä¸€å¼µ â†’';

                setTimeout(() => {
                    // æ’­æ”¾å‰å†æ¬¡å–æ¶ˆï¼Œç¢ºä¿ä¸­æ–·
                    window.speechSynthesis.cancel();
                    speakFullAnswer(() => { /* æ‰‹å‹•ç¿»ç‰Œä¸éœ€å›èª¿ */ });
                }, 500);
            } else {
                nextButton.textContent = 'ä¸‹ä¸€å¼µ/çœ‹ç­”æ¡ˆ â†’';
            }
        };

        // ç¶å®šé»æ“Šäº‹ä»¶
        termLine.addEventListener('click', manualToggleListener);
        headerElement.addEventListener('click', manualToggleListener);


        document.addEventListener('DOMContentLoaded', async () => {
            // 1. åˆå§‹è¼‰å…¥ç¬¬ä¸€æ‰¹æ•¸æ“š 
            if (cardCache.length === 0 && total_count > 0) {
                // æ ¹æ“šå¾ä¼ºæœå™¨ç²å¾—çš„ current_index æ±ºå®šæ‡‰è©²å¾å“ªä¸€ç­†é–‹å§‹è¼‰å…¥å¿«å–
                const requiredBatchStart = Math.floor(current_index / BATCH_SIZE) * BATCH_SIZE;

                await fetchAndCacheBatch(requiredBatchStart);
            }

            // 2. æ¸²æŸ“ç¬¬ä¸€å¼µå¡ç‰‡
            const initialCard = cardCache[current_index - currentBatchStart];
            if (initialCard) {
                // ğŸš¨ ä¿®æ­£é»ï¼šåˆå§‹è¼‰å…¥æ™‚ä¹Ÿæ’­æ”¾ Term èªéŸ³ (true)
                renderCard(initialCard, true);

                // 3. ç¶å®šå€‹åˆ¥èªéŸ³æŒ‰éˆ•ï¼Œä¸¦åœ¨é»æ“Šæ™‚åœæ­¢è‡ªå‹•æ’­æ”¾
                document.getElementById('term-tts-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    stopAutoPlayLoop(true);
                    if (currentCardData && currentCardData.term) {
                        // æ’­æ”¾å‰å–æ¶ˆæ‰€æœ‰èªéŸ³
                        window.speechSynthesis.cancel();
                        speakText(currentCardData.term, 'ja-JP');
                    }
                });

                document.getElementById('example-tts-btn').addEventListener('click', (e) => {
                    e.stopPropagation();
                    stopAutoPlayLoop(true);
                    if (currentCardData && currentCardData.example_sentence) {
                        // æ’­æ”¾å‰å–æ¶ˆæ‰€æœ‰èªéŸ³
                        window.speechSynthesis.cancel();
                        speakText(currentCardData.example_sentence, 'ja-JP');
                    }
                });

                // 4. åˆå§‹åŒ–è‡ªå‹•æ’­æ”¾ç‹€æ…‹
                const storedInterval = sessionStorage.getItem(INTERVAL_KEY);
                if (storedInterval) {
                    intervalSelect.value = storedInterval;
                }

                if (sessionStorage.getItem(SESSION_KEY) === 'true') {
                    playPauseBtn.innerHTML = 'â¸ï¸ æš«åœ';
                    intervalSelect.disabled = true;
                    // é é¢è¼‰å…¥æ™‚ç¹¼çºŒè‡ªå‹•æ’­æ”¾æµç¨‹
                    startAutoplaySequence();
                } else {
                    playPauseBtn.innerHTML = 'â–¶ï¸ è‡ªå‹•æ’­æ”¾';
                    intervalSelect.disabled = false;
                }


            } else {
                termElement.textContent = 'æ¸…å–®ç‚ºç©ºï¼Œè«‹å›è¨­å®šé é‡æ–°è¼‰å…¥ã€‚';
            }
        });
    </script>
</body>

</html>