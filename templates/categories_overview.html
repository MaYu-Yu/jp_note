<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†é¡ç¸½è¦½èˆ‡ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .category-link {
            text-decoration: none;
            color: inherit;
        }

        .category-card {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            position: relative;
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2) !important;
        }

        /* èª¿æ•´æŒ‰éˆ•çš„ä½ç½®èˆ‡å¤§å° */
        .delete-btn-overlay {
            position: absolute;
            top: 10px;
            /* å¢åŠ é ‚éƒ¨é–“è· */
            right: 10px;
            /* å¢åŠ å³å´é–“è· */
            z-index: 10;
            line-height: 1;
            padding: 0.5rem;
            /* å¢åŠ æŒ‰éˆ•å…§é‚Šè· */
        }

        /* ç·¨è¼¯æŒ‰éˆ•ä½ç½® */
        .edit-btn-overlay {
            position: absolute;
            top: 10px;
            right: 55px;
            z-index: 10;
            line-height: 1;
            padding: 0.5rem;
        }

        /* è®“åœ–æ¨™æœ¬èº«æ›´å¤§ */
        .delete-btn-overlay .fa-trash {
            font-size: 1.2rem;
            /* è‡ªå®šç¾©æ›´å¤§çš„åœ–æ¨™å¤§å° */
        }

        /* è®“ç·¨è¼¯åœ–æ¨™æœ¬èº«æ›´å¤§ */
        .edit-btn-overlay .fa-edit {
            font-size: 1.2rem;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-5 text-center">ğŸ·ï¸ åˆ†é¡ç¸½è¦½èˆ‡ç®¡ç†</h1>
        <div class="mb-4 d-flex gap-2 justify-content-center">
            <a href="{{ url_for('home') }}" class="btn btn-secondary mb-3 ms-2">ğŸ  è¿”å›é¦–é </a>
            <button id="add-category-btn" class="btn btn-warning mb-3 ms-2 text-white">ï¼‹ æ–°å¢åˆ†é¡</button>

            <a href="{{ url_for('add_vocab') }}" class="btn btn-success mb-3 ms-2">ï¼‹ æ–°å¢å–®å­—</a>
            <a href="{{ url_for('add_grammar') }}" class="btn btn-info mb-3 ms-2">ï¼‹ æ–°å¢æ–‡æ³•</a>
        </div>
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        <div class="alert alert-info">
            {% for category, message in messages %}
            <p class="mb-0">{{ message }}</p>
            {% endfor %}
        </div>
        {% endif %}
        {% endwith %}

        {% if categories %}
        <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4">
            {% for category in categories %}
            <div class="col">
                <div class="category-card card text-white bg-info mb-3 shadow">
                    <a href="{{ url_for('list_page', data_type='vocab', category=category.name) }}"
                        class="category-link">
                        <div class="card-body">
                            <h5 class="card-title">{{ category.name }}</h5>
                            <p class="card-text">å…± {{ category.count }} ç­†</p>
                        </div>
                    </a>

                    <button class="edit-btn-overlay btn btn-sm btn-light p-1" data-category="{{ category.name }}"
                        title="ç·¨è¼¯åˆ†é¡åç¨±">
                        <i class="fas fa-edit text-primary"></i>
                    </button>

                    <button class="delete-btn-overlay btn btn-sm btn-light p-1" data-category="{{ category.name }}"
                        title="åˆªé™¤æ­¤åˆ†é¡">
                        <i class="fas fa-trash text-danger"></i>
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="alert alert-warning text-center">
            ç›®å‰æ²’æœ‰ä»»ä½•åˆ†é¡ã€‚è«‹åœ¨æ–°å¢å–®å­—æˆ–æ–‡æ³•æ™‚å»ºç«‹åˆ†é¡ã€‚
        </div>
        {% endif %}

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const addCategoryBtn = document.getElementById('add-category-btn');
        const sqlRegex = /\b(delete|drop|insert|select|update|union|truncate|exec)\b/i;

        // çµ±ä¸€é©—è­‰å‡½å¼
        function check_input(text, isCategory = false) {
            const trimmed = text ? text.trim() : "";
            if (trimmed.length === 0) return "å…§å®¹ä¸èƒ½ç‚ºç©ºï¼";
            if (isCategory && trimmed.includes(',')) return "åç¨±ä¸èƒ½åŒ…å«é€—è™Ÿã€Œ,ã€";
            if (sqlRegex.test(trimmed)) return "åµæ¸¬åˆ°éæ³•ç³»çµ±æŒ‡ä»¤ã€‚";
            return null;
        }

        // æ–°å¢åˆ†é¡
        addCategoryBtn.addEventListener('click', function () {
            const categoryName = prompt("è«‹è¼¸å…¥æ–°åˆ†é¡åç¨±ï¼š");
            if (categoryName === null) return;
            let trimmedName = categoryName.trim();
            const error = check_input(trimmedName, true);
            if (error) { alert(error); return; }

            fetch("/api/add_category", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: trimmedName }),
            })
            .then(res => res.json())
            .then(data => { if (data.success) window.location.reload(); else alert(data.message); });
        });

        // ä¿®æ”¹åˆ†é¡ (è§£æ±ºå¤±æ•ˆé—œéµï¼šencodeURIComponent)
        const editButtons = document.querySelectorAll('.edit-btn-overlay');
        editButtons.forEach(button => {
            button.addEventListener('click', function (event) {
                event.stopPropagation();
                event.preventDefault();
                const oldName = this.getAttribute('data-category');
                const newName = prompt(`ç·¨è¼¯åˆ†é¡ã€Œ${oldName}ã€ã€‚è«‹è¼¸å…¥æ–°çš„åç¨±ï¼š`, oldName);

                if (newName === null || newName.trim() === oldName) return;
                let trimmedName = newName.trim();
                const error = check_input(trimmedName, true);
                if (error) { alert(error); return; }

                // ä½¿ç”¨ encodeURIComponent ç¢ºä¿æ—¥æ–‡ç¬¦è™Ÿèƒ½åœ¨ç¶²å€å‚³è¼¸
                fetch(`/api/edit_category/${encodeURIComponent(oldName)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_name: trimmedName })
                })
                .then(res => res.json())
                .then(data => { if (data.success) window.location.reload(); else alert(data.message); });
            });
        });

        // åˆªé™¤åˆ†é¡ (è§£æ±ºå¤±æ•ˆé—œéµï¼šencodeURIComponent)
        const deleteButtons = document.querySelectorAll('.delete-btn-overlay');
        deleteButtons.forEach(button => {
            button.addEventListener('click', function (event) {
                event.stopPropagation();
                event.preventDefault();
                const categoryName = this.getAttribute('data-category');

                if (confirm(`ç¢ºå®šè¦ç§»é™¤ã€Œ${categoryName}ã€å—ï¼Ÿ`)) {
                    // ä½¿ç”¨ encodeURIComponent
                    fetch(`/api/delete_category/${encodeURIComponent(categoryName)}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                    })
                    .then(res => res.json())
                    .then(data => { if (data.success) window.location.reload(); else alert(data.message); });
                }
            });
        });

        // é€šç”¨è¡¨å–®é©—è­‰
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function (e) {
                const inputs = form.querySelectorAll('input[type="text"], textarea');
                for (let input of inputs) {
                    const trimmedValue = input.value.trim();
                    const error = check_input(trimmedValue, input.id === "new_categories");
                    if (error && (input.hasAttribute('required') || input.value.length > 0)) {
                        e.preventDefault();
                        alert(error);
                        input.focus();
                        return;
                    }
                    input.value = trimmedValue;
                }
            });
        });
    });
</script>
</body>

</html>