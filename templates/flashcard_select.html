<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—å¡è¨­å®š</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-body {
            padding: 30px;
        }
        .form-select, .btn {
            font-size: 1.1rem;
        }
        #pos-filter-group {
            transition: opacity 0.3s ease, max-height 0.3s ease;
            overflow: hidden;
            max-height: 200px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">ğŸ´ å–®å­—å¡å­¸ç¿’è¨­å®š</h1>
        <a href="{{ url_for('home') }}" class="btn btn-secondary mb-4">â† è¿”å›é¦–é </a>

        <div class="card shadow-lg">
            <div class="card-body">
                <form id="flashcard-form"> 
                    <div class="mb-4">
                        <label for="data_type" class="form-label fw-bold">1. é¸æ“‡å­¸ç¿’å…§å®¹</label>
                        <select class="form-select" id="data_type" name="data_type">
                            <option value="all">æ‰€æœ‰å…§å®¹ (å–®å­—+æ–‡æ³•)</option>
                            <option value="vocab">åƒ…å–®å­—</option>
                            <option value="grammar">åƒ…æ–‡æ³•</option>
                        </select>
                    </div>
                    
                    <div class="mb-4" id="pos-filter-group">
                        <label for="pos_filter" class="form-label fw-bold">2. è©æ€§ç¯©é¸</label>
                        <select class="form-select" id="pos_filter" name="pos_filter">
                            <option value="all">æ‰€æœ‰è©æ€§</option>
                            {% for pos in parts_of_speech %}
                            <option value="{{ pos.part_of_speech }}">{{ pos.part_of_speech }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label for="category_filter" class="form-label fw-bold">3. åˆ†é¡ç¯©é¸</label>
                        <select class="form-select" id="category_filter" name="category_filter">
                            <option value="all">æ‰€æœ‰åˆ†é¡</option>
                            {% for cat in categories %}
                            <option value="{{ cat }}">{{ cat }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="form-label fw-bold">4. é¸æ“‡é–‹å§‹é»</label>
                        <div class="d-flex gap-3">
                            <button type="button" class="btn btn-outline-info w-50" onclick="startDeck('resume')">â¯ï¸ æ¥çºŒä¸Šæ¬¡é€²åº¦</button>
                            <button type="button" class="btn btn-outline-warning w-50" onclick="startDeck('start')">ğŸ”„ å¾é ­é–‹å§‹ (è¼‰å…¥æ–°ç¯©é¸æ¢ä»¶)</button>
                        </div>
                        <small class="form-text text-muted mt-2 d-block">ä¸Šæ¬¡å­¸ç¿’é€²åº¦ï¼š<span id="last-index-info">æ­£åœ¨åˆå§‹åŒ–...</span></small>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å‡½æ•¸ï¼šæ§åˆ¶è©æ€§ç¯©é¸å™¨ï¼ˆpos_filterï¼‰çš„é¡¯ç¤ºèˆ‡éš±è—
        function togglePosFilter() {
            const dataType = document.getElementById('data_type').value;
            const posFilterDiv = document.getElementById('pos-filter-group');
            
            // åªæœ‰åœ¨é¸æ“‡ 'vocab' (å–®å­—) æ™‚æ‰é¡¯ç¤ºè©æ€§ç¯©é¸
            if (dataType === 'vocab') {
                posFilterDiv.style.display = 'block';
            } else {
                posFilterDiv.style.display = 'none';
            }
        }
        
        // é é¢åŠ è¼‰æ™‚çš„åˆå§‹åŒ–è¨­ç½®
        document.addEventListener('DOMContentLoaded', () => {
            togglePosFilter(); 
            document.getElementById('data_type').addEventListener('change', togglePosFilter);

            // åˆå§‹ç‹€æ…‹æç¤ºï¼šç•¶å‰ç¯©é¸å™¨çš„å€¼ï¼Œå°‡ç”¨ä¾†æª¢æŸ¥ä¸Šæ¬¡é€²åº¦ã€‚
            document.getElementById('last-index-info').innerText = "è«‹é¸æ“‡å…§å®¹å¾Œï¼Œé»æ“Šã€Œå¾é ­é–‹å§‹ã€è¼‰å…¥æ•¸æ“šï¼Œæˆ–é»æ“Šã€Œæ¥çºŒä¸Šæ¬¡é€²åº¦ã€ã€‚";
        });

        // å‡½æ•¸ï¼šå•Ÿå‹•å–®å­—å¡é é¢
        async function startDeck(action) {
            
            // ğŸš¨ ä¿®æ­£é»ï¼šå¦‚æœé¸æ“‡ã€Œæ¥çºŒä¸Šæ¬¡é€²åº¦ã€ï¼Œç›´æ¥å°èˆªã€‚
            // é é¢è¼‰å…¥æ™‚çš„ flashcard_deck/<action> è·¯ç”±æœƒæª¢æŸ¥ Session ä¸­æ˜¯å¦æœ‰æ•¸æ“šã€‚
            if (action === 'resume') {
                // ç›´æ¥å°èˆªåˆ°å–®å­—å¡é¡¯ç¤ºé é¢
                window.location.href = `{{ url_for('flashcard_deck', action='resume') }}`;
                return;
            }

            // å°æ–¼ã€Œå¾é ­é–‹å§‹ã€ (start) æˆ–å…¶ä»–éœ€è¦é‡æ–°è¼‰å…¥æ•¸æ“šçš„è¡Œç‚ºï¼Œå‰‡åŸ·è¡Œ loadAndCheckData
            const dataLoaded = await loadAndCheckData(); 

            if (!dataLoaded) {
                return;
            }
            
            // å°èˆªåˆ°å–®å­—å¡é¡¯ç¤ºé é¢
            window.location.href = `{{ url_for('flashcard_deck', action='') }}${action}`;
        }
        
        // å‡½æ•¸ï¼šåŠ è¼‰æ•¸æ“šä¸¦æª¢æŸ¥ä¸Šæ¬¡é€²åº¦ï¼ŒæˆåŠŸå¾Œå°‡å–®å­—å¡æ•¸æ“šå­˜å…¥ Session
        async function loadAndCheckData() {
            const formData = new FormData(document.getElementById('flashcard-form'));
            const data = Object.fromEntries(formData.entries());
            
            // ç¢ºä¿ pos_filter åœ¨é¸æ“‡éå–®å­—æ™‚ç‚º 'all'
            if (data.data_type !== 'vocab') {
                data.pos_filter = 'all';
            }

            const lastIndexInfoElement = document.getElementById('last-index-info');
            lastIndexInfoElement.innerText = "â³ æ­£åœ¨è¼‰å…¥æ•¸æ“šï¼Œè«‹ç¨å€™...";

            try {
                // ç™¼é€è«‹æ±‚åˆ° app.py ä¸­çš„ flashcard_data
                const response = await fetch("{{ url_for('flashcard_data') }}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success && result.count > 0) {
                    // é¡¯ç¤ºè¼‰å…¥çµæœï¼Œä½†å°èˆªæœƒç”± startDeck æ±ºå®š
                    lastIndexInfoElement.innerText = 
                        `âœ… æ•¸æ“šè¼‰å…¥æˆåŠŸï¼å…± ${result.count} ç­†ã€‚ä¸Šæ¬¡èƒŒåˆ°ç¬¬ ${result.last_index + 1} ç­†ã€‚`;
                    return true; 
                } else if (result.count === 0) {
                    lastIndexInfoElement.innerText = "âŒ æ¸…å–®ä¸­æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ•¸æ“šï¼è«‹èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚";
                    alert("æ¸…å–®ä¸­æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ•¸æ“šï¼è«‹èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚");
                    return false; 
                } else {
                    lastIndexInfoElement.innerText = "âŒ æ•¸æ“šåŠ è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æ—¥èªŒã€‚";
                    return false; 
                }
            } catch (error) {
                console.error('æ•¸æ“šåŠ è¼‰éŒ¯èª¤:', error);
                lastIndexInfoElement.innerText = "âŒ ç¶²çµ¡æˆ–ä¼ºæœå™¨éŒ¯èª¤ï¼Œæ•¸æ“šåŠ è¼‰å¤±æ•—ã€‚";
                return false;
            }
        }
    </script>
</body>
</html>