<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—å¡è¨­å®š</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* æ•´é«”å®¹å™¨èˆ‡å¡ç‰‡æ¨£å¼ */
        .card-body {
            padding: 30px;
        }

        .form-label {
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            display: block;
        }

        .d-flex.flex-wrap button {
            /* å…±ç”¨åŸºç¤æ¨£å¼ */
            margin: 5px;
            border-radius: 12px; /* ç¢ºä¿åœ“æ½¤æ–¹å½¢å’Œå°ç¨±åœ“å¼§ */
            font-weight: 500;
            padding: 10px 15px; /* ç¢ºä¿åœ“å¼§å°ç¨±æ‰€éœ€çš„é£½æ»¿åº¦ */
            min-width: 100px;
            transition: all 0.2s ease-in-out;
            text-align: center;
            border-width: 2px;
        }

        /* 1. é¸æ“‡å­¸ç¿’å…§å®¹ï¼š3 å€‹æŒ‰éˆ•ç­‰åˆ†ä¸€è¡Œ */
        #data-type-button-group button {
            width: calc(33.333% - 10px);
            flex-grow: 1;
            min-width: unset;
        }

        /* 2 & 3. åˆ†é¡å’Œè©æ€§çš„ "æ‰€æœ‰" é¸é …ï¼šå…¨å¯¬ç¨ç«‹æˆè¡Œ */
        .all-full-width {
            width: calc(100% - 10px) !important; /* ä½”æ»¿ä¸€è¡Œä¸¦ä¿æŒé‚Šè· */
            margin-bottom: 10px !important;
            flex-grow: 0 !important;
            font-size: 1.05rem;
        }

        /* 2 & 3. åˆ†é¡å’Œè©æ€§çš„ç´°é …é¸é …ï¼š4 å€‹æŒ‰éˆ•ä¸€æ’ */
        #category-button-group button:not(.all-full-width),
        #pos-button-group button:not(.all-full-width) {
            width: calc(25% - 10px);
            min-width: 100px;
        }

        /* å­¸ç¿’å…§å®¹ / åˆ†é¡ç¯©é¸ï¼ˆPrimary è—è‰²ï¼‰ */
        .btn-highlight {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
            font-weight: bold;
        }
        .btn-outline-highlight {
            color: #007bff;
            border-color: #007bff;
            font-weight: 500;
        }

        /* è©æ€§ç¯©é¸ï¼ˆSuccess ç¶ è‰²ï¼‰ */
        .btn-success-highlight {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
            font-weight: bold;
        }
        .btn-outline-success-highlight {
            color: #28a745;
            border-color: #28a745;
            font-weight: 500;
        }

        /* é»æ“Šæˆ–é¸ä¸­æ™‚çš„è¦–è¦ºæ•ˆæœ */
        .btn:active, .btn.active, .btn:focus {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        /* è©æ€§ç¯©é¸ç¾¤çµ„çš„å‹•ç•«å’Œéš±è—è¨­å®š */
        #pos-filter-group {
            transition: opacity 0.3s ease, max-height 0.3s ease;
            overflow: hidden;
            max-height: 1000px; 
        }

        /* é¸æ“‡é–‹å§‹é»çš„æŒ‰éˆ•æ¨£å¼ */
        .start-button-group button {
            font-size: 1.1rem;
            padding: 12px;
            border-radius: 10px;
            font-weight: bold;
            flex-grow: 1;
        }

    </style>
</head>

<body>
    <div class="container mt-5">
        <h1 class="mb-4">ğŸ´ å–®å­—å¡å­¸ç¿’è¨­å®š</h1>
        <div class="mb-4 d-flex gap-2">
            <button onclick="history.back()" class="btn btn-secondary mb-3 ms-2">â† è¿”å›ä¸Šé </button>
            <a href="{{ url_for('home') }}" class="btn btn-secondary mb-3 ms-2">ğŸ  è¿”å›é¦–é </a>
        </div>

        <div class="card shadow-lg">
            <div class="card-body">
                <form id="flashcard-form">

                    {# 1. é¸æ“‡å­¸ç¿’å…§å®¹ (æŒ‰éˆ•çµ„) #}
                    <div class="mb-4">
                        <label class="form-label fw-bold">1. é¸æ“‡å­¸ç¿’å…§å®¹</label>
                        <input type="hidden" id="data_type" name="data_type"
                            value="{{ last_filters.data_type or 'all' }}">

                        <div id="data-type-button-group" class="d-flex flex-wrap justify-content-start" role="group">
                            <button type="button" class="btn btn-outline-highlight data-type-option"
                                data-value="all">æ‰€æœ‰å…§å®¹ (å–®å­—+æ–‡æ³•)</button>
                            <button type="button" class="btn btn-outline-highlight data-type-option"
                                data-value="vocab">åƒ…å–®å­—</button>
                            <button type="button" class="btn btn-outline-highlight data-type-option"
                                data-value="grammar">åƒ…æ–‡æ³•</button>
                        </div>
                    </div>

                    {# 2. åˆ†é¡ç¯©é¸ (æŒ‰éˆ•çµ„) #}
                    <div class="mb-4">
                        <label class="form-label fw-bold">2. åˆ†é¡ç¯©é¸</label>
                        <input type="hidden" id="category_filter" name="category_filter"
                            value="{{ last_filters.category_filter or 'all' }}">

                        <div id="category-button-group" class="d-flex flex-wrap justify-content-start" role="group">
                            {# é è¨­é¸é …ï¼šæ‰€æœ‰åˆ†é¡ - ç¨ç«‹æˆè¡Œ #}
                            <button type="button" class="btn btn-outline-highlight category-option all-full-width"
                                data-value="all">æ‰€æœ‰åˆ†é¡</button>

                            {# è¿­ä»£è³‡æ–™åº«ä¸­æ‰€æœ‰åˆ†é¡ #}
                            {% for cat in all_categories %}
                            <button type="button" class="btn btn-outline-primary category-option"
                                data-value="{{ cat }}">{{ cat }}</button>
                            {% endfor %}
                        </div>
                    </div>

                    {# 3. è©æ€§ç¯©é¸ (æŒ‰éˆ•çµ„) #}
                    <div class="mb-4" id="pos-filter-group" style="display: none;">
                        <label class="form-label fw-bold">3. è©æ€§ç¯©é¸</label>
                        <input type="hidden" id="pos_filter" name="pos_filter"
                            value="{{ last_filters.pos_filter or 'all' }}">

                        <div id="pos-button-group" class="d-flex flex-wrap justify-content-start" role="group">
                            {# é è¨­é¸é …ï¼šæ‰€æœ‰è©æ€§ - ç¨ç«‹æˆè¡Œ #}
                            <button type="button" class="btn btn-outline-success-highlight pos-option all-full-width"
                                data-value="all">æ‰€æœ‰è©æ€§</button>

                            {# è¿­ä»£ MASTER_POS_LIST_RAWï¼Œä½† data-value å‚³éç¸®å¯« #}
                            {% for pos_raw in all_pos %}
                                {% set pos_abbr = pos_raw.split(' ')[0].strip() %}
                                <button type="button" class="btn btn-outline-success pos-option"
                                    data-value="{{ pos_abbr }}">{{ pos_raw }}</button>
                            {% endfor %}
                        </div>
                    </div>

                    {# 4. é¸æ“‡é–‹å§‹é» #}
                    <div class="mb-4">
                        <label class="form-label fw-bold">4. é¸æ“‡é–‹å§‹é»</label>
                        <div class="d-flex gap-3 start-button-group">
                            <button type="button" class="btn btn-info w-50" onclick="startDeck('resume')">â¯ï¸
                                æ¥çºŒä¸Šæ¬¡é€²åº¦</button>
                            <button type="button" class="btn btn-warning w-50" onclick="startDeck('start')">ğŸ”„
                                å¾é ­é–‹å§‹ (è¼‰å…¥æ–°ç¯©é¸æ¢ä»¶)</button>
                        </div>
                        <small class="form-text text-muted mt-2 d-block">ä¸Šæ¬¡å­¸ç¿’é€²åº¦ï¼š<span
                                id="last-index-info">æ­£åœ¨åˆå§‹åŒ–...</span></small>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å‡½æ•¸ï¼šè™•ç†æŒ‰éˆ•ç¯©é¸å™¨çš„é»æ“Šå’Œç‹€æ…‹æ›´æ–°
        function setupButtonFilters(groupSelector, inputId, optionClass) {
            const hiddenInput = document.getElementById(inputId);
            const options = document.querySelectorAll(groupSelector + ' .' + optionClass);

            // æ±ºå®šæŒ‰éˆ•çš„é¡è‰²é¡åˆ¥å’Œé«˜äº®é¡åˆ¥
            let defaultOutlineClass, activeClass, highlightOutlineClass, highlightActiveClass;

            if (groupSelector === '#pos-button-group') {
                defaultOutlineClass = 'btn-outline-success';
                activeClass = 'btn-success';
                highlightOutlineClass = 'btn-outline-success-highlight';
                highlightActiveClass = 'btn-success-highlight';
            } else {
                // é©ç”¨æ–¼ data_type å’Œ category_filter
                defaultOutlineClass = 'btn-outline-primary';
                activeClass = 'btn-primary';
                highlightOutlineClass = 'btn-outline-highlight';
                highlightActiveClass = 'btn-highlight';
            }

            // 1. åˆå§‹åŒ–ç‹€æ…‹
            const initialValue = hiddenInput.value;
            options.forEach(btn => {
                const isAllButton = btn.dataset.value === 'all';
                const isDataTypeButton = groupSelector === '#data-type-button-group';

                // æ±ºå®šæŒ‰éˆ•çš„è¼ªå»“æ¨£å¼
                let outlineClass = (isAllButton || isDataTypeButton) ? highlightOutlineClass : defaultOutlineClass;

                // æ¸…é™¤æ‰€æœ‰å¯èƒ½çš„ç‹€æ…‹é¡åˆ¥
                btn.classList.remove(defaultOutlineClass, activeClass, highlightOutlineClass, highlightActiveClass);

                if (btn.dataset.value === initialValue) {
                    // é¸ä¸­çš„æŒ‰éˆ•ï¼šä½¿ç”¨å¯¦å¿ƒé«˜äº®/å¯¦å¿ƒé¡è‰²
                    let activeColorClass = (isAllButton || isDataTypeButton) ? highlightActiveClass : activeClass;
                    btn.classList.add(activeColorClass);
                } else {
                    // æœªé¸ä¸­çš„æŒ‰éˆ•ï¼šä½¿ç”¨è¼ªå»“é«˜äº®/è¼ªå»“é¡è‰²
                    btn.classList.add(outlineClass);
                }
            });

            // 2. é»æ“Šè™•ç†å™¨
            options.forEach(btn => {
                btn.addEventListener('click', function () {
                    // é‡è¨­æ‰€æœ‰æŒ‰éˆ•ç‹€æ…‹
                    options.forEach(otherBtn => {
                        const isOtherAllButton = otherBtn.dataset.value === 'all';
                        const isOtherDataTypeButton = groupSelector === '#data-type-button-group';

                        // ç§»é™¤æ‰€æœ‰æ¿€æ´»ç‹€æ…‹
                        otherBtn.classList.remove(activeClass, highlightActiveClass);

                        // è¨­ç½®ç‚ºéæ¿€æ´»è¼ªå»“ç‹€æ…‹
                        if (isOtherAllButton || isOtherDataTypeButton) {
                            otherBtn.classList.add(highlightOutlineClass);
                        } else {
                            otherBtn.classList.add(defaultOutlineClass);
                        }
                    });

                    // è¨­å®šæ–°é¸ä¸­çš„æŒ‰éˆ•ç‹€æ…‹
                    hiddenInput.value = this.dataset.value;
                    const isCurrentAllButton = this.dataset.value === 'all';
                    const isCurrentDataTypeButton = groupSelector === '#data-type-button-group';

                    let currentOutlineClass = (isCurrentAllButton || isCurrentDataTypeButton) ? highlightOutlineClass : defaultOutlineClass;
                    let currentActiveClass = (isCurrentAllButton || isCurrentDataTypeButton) ? highlightActiveClass : activeClass;


                    this.classList.remove(currentOutlineClass);
                    this.classList.add(currentActiveClass);

                    // å¦‚æœæ˜¯ 'data_type' æ”¹è®Šï¼Œè§¸ç™¼è©æ€§ç¯©é¸å™¨çš„é¡¯ç¤º/éš±è—æª¢æŸ¥
                    if (groupSelector === '#data-type-button-group') {
                        togglePosFilter();
                    }
                });
            });
        }

        // å‡½æ•¸ï¼šæ§åˆ¶è©æ€§ç¯©é¸å™¨ï¼ˆpos_filterï¼‰çš„é¡¯ç¤ºèˆ‡éš±è—
        function togglePosFilter() {
            const dataType = document.getElementById('data_type').value;
            const posFilterDiv = document.getElementById('pos-filter-group');
            const posHiddenInput = document.getElementById('pos_filter');

            if (dataType === 'vocab') {
                posFilterDiv.style.display = 'block';
                // ç•¶è©æ€§ç¯©é¸å™¨é¡¯ç¤ºæ™‚ï¼Œå¼·åˆ¶åˆ·æ–°æŒ‰éˆ•è¦–è¦ºç‹€æ…‹ä»¥åŒ¹é…ç•¶å‰ pos_filter çš„å€¼ã€‚
                setupButtonFilters('#pos-button-group', 'pos_filter', 'pos-option'); 
            } else {
                posFilterDiv.style.display = 'none';
                
                // å¿…é ˆå…ˆå°‡å€¼é‡è¨­ç‚º 'all'
                posHiddenInput.value = 'all';

                // ç•¶è©æ€§ç¯©é¸å™¨éš±è—æ™‚ï¼Œç«‹å³å°‡è¦–è¦ºç‹€æ…‹åˆ·æ–°ç‚ºã€Œæ‰€æœ‰è©æ€§ã€è¢«é¸ä¸­ï¼Œç¢ºä¿ä¸‹æ¬¡åˆ‡æ›å›ä¾†æ™‚ç‹€æ…‹æ­£ç¢ºã€‚
                setupButtonFilters('#pos-button-group', 'pos_filter', 'pos-option');

                // ç§»é™¤åŸæœ‰çš„æ‰‹å‹•é‡ç½®é‚è¼¯ï¼Œå› ç‚º setupButtonFilters æ›´ç‚ºé€šç”¨å¯é ã€‚
            }
        }

        // é é¢åŠ è¼‰æ™‚çš„åˆå§‹åŒ–è¨­ç½®
        document.addEventListener('DOMContentLoaded', () => {

            // è¨­ç½®æ‰€æœ‰æŒ‰éˆ•éæ¿¾å™¨
            setupButtonFilters('#data-type-button-group', 'data_type', 'data-type-option');
            setupButtonFilters('#category-button-group', 'category_filter', 'category-option');
            setupButtonFilters('#pos-button-group', 'pos_filter', 'pos-option');

            // åˆå§‹åŒ–æ™‚æª¢æŸ¥è©æ€§ç¯©é¸å™¨æ˜¯å¦æ‡‰é¡¯ç¤º/éš±è—
            togglePosFilter();

            document.getElementById('last-index-info').innerText = "è«‹é¸æ“‡å…§å®¹å¾Œï¼Œé»æ“Šã€Œå¾é ­é–‹å§‹ã€è¼‰å…¥æ•¸æ“šï¼Œæˆ–é»æ“Šã€Œæ¥çºŒä¸Šæ¬¡é€²åº¦ã€ã€‚";
        });

        // å‡½æ•¸ï¼šå•Ÿå‹•å–®å­—å¡é é¢
        async function startDeck(action) {

            if (action === 'resume') {
                window.location.href = `{{ url_for('flashcard_deck') }}?action=resume`;
                return;
            }

            const dataLoaded = await loadAndCheckData();

            if (!dataLoaded) {
                return;
            }

            window.location.href = `{{ url_for('flashcard_deck') }}?action=start`;
        }

        // å‡½æ•¸ï¼šåŠ è¼‰æ•¸æ“šä¸¦æª¢æŸ¥ä¸Šæ¬¡é€²åº¦ï¼ŒæˆåŠŸå¾Œå°‡å–®å­—å¡æ•¸æ“šå­˜å…¥ Session
        async function loadAndCheckData() {
            const formData = new FormData(document.getElementById('flashcard-form'));
            const data = Object.fromEntries(formData.entries());

            if (data.data_type !== 'vocab') {
                data.pos_filter = 'all';
            }

            const lastIndexInfoElement = document.getElementById('last-index-info');
            lastIndexInfoElement.innerText = "â³ æ­£åœ¨è¼‰å…¥æ•¸æ“šï¼Œè«‹ç¨å€™...";

            try {
                const response = await fetch("{{ url_for('flashcard_data') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success && result.count > 0) {
                    lastIndexInfoElement.innerText =
                        `âœ… æ•¸æ“šè¼‰å…¥æˆåŠŸï¼å…± ${result.count} ç­†ã€‚ä¸Šæ¬¡èƒŒåˆ°ç¬¬ ${result.last_index + 1} ç­†ã€‚`;
                    return true;
                } else if (result.count === 0) {
                    lastIndexInfoElement.innerText = "âŒ æ¸…å–®ä¸­æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ•¸æ“šï¼è«‹èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚";
                    alert("æ¸…å–®ä¸­æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ•¸æ“šï¼è«‹èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚");
                    return false;
                } else {
                    lastIndexInfoElement.innerText = "âŒ æ•¸æ“šåŠ è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æ—¥èªŒã€‚";
                    return false;
                }
            } catch (error) {
                console.error('æ•¸æ“šåŠ è¼‰éŒ¯èª¤:', error);
                lastIndexInfoElement.innerText = "âŒ ç¶²çµ¡æˆ–ä¼ºæœå™¨éŒ¯èª¤ï¼Œæ•¸æ“šåŠ è¼‰å¤±æ•—ã€‚";
                return false;
            }
        }
    </script>
</body>

</html>