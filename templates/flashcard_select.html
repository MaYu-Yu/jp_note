<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å–®å­—å¡è¨­å®š</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card-body {
            padding: 30px;
        }
        .form-select, .btn {
            font-size: 1.1rem;
        }
        #pos-filter-group {
            transition: opacity 0.3s ease, max-height 0.3s ease;
            overflow: hidden;
            max-height: 200px;
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="mb-4">ğŸ´ å–®å­—å¡å­¸ç¿’è¨­å®š</h1>
        <a href="{{ url_for('home') }}" class="btn btn-secondary mb-4">â† è¿”å›é¦–é </a>

        <div class="card shadow-lg">
            <div class="card-body">
                <form id="flashcard-form"> 
                    <div class="mb-4">
                        <label for="data_type" class="form-label fw-bold">1. é¸æ“‡å­¸ç¿’å…§å®¹</label>
                        <select class="form-select" id="data_type" name="data_type">
                            <option value="all">æ‰€æœ‰å…§å®¹ (å–®å­—+æ–‡æ³•)</option>
                            <option value="vocab">åƒ…å–®å­—</option>
                            <option value="grammar">åƒ…æ–‡æ³•</option>
                        </select>
                    </div>

                    <div class="mb-4" id="pos-filter-group">
                        <label for="pos_filter" class="form-label fw-bold">2. è©æ€§ç¯©é¸</label>
                        <select class="form-select" id="pos_filter" name="pos_filter">
                            <option value="all">æ‰€æœ‰è©æ€§</option>
                            {% for pos in parts_of_speech %}
                            <option value="{{ pos.part_of_speech }}">{{ pos.part_of_speech }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold">3. é¸æ“‡é–‹å§‹é»</label>
                        <div class="d-flex gap-3">
                            <button type="button" class="btn btn-outline-info w-50" onclick="startDeck('resume')">â¯ï¸ æ¥çºŒä¸Šæ¬¡é€²åº¦</button>
                            <button type="button" class="btn btn-outline-warning w-50" onclick="startDeck('start')">ğŸ”„ å¾é ­é–‹å§‹</button>
                        </div>
                        <small class="form-text text-muted mt-2 d-block">ä¸Šæ¬¡å­¸ç¿’é€²åº¦ï¼š<span id="last-index-info">æ­£åœ¨åˆå§‹åŒ–...</span></small>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å…¨å±€è®Šæ•¸ï¼ˆæ­¤è™•ä¸å†ä½¿ç”¨ï¼Œå› ç‚ºæ•¸æ“šåŠ è¼‰å°‡åœ¨é»æ“Šæ™‚å®Œæˆï¼‰

        // å‡½æ•¸ï¼šæ§åˆ¶è©æ€§ç¯©é¸å™¨ï¼ˆpos_filterï¼‰çš„é¡¯ç¤ºèˆ‡éš±è—
        function togglePosFilter() {
            const dataType = document.getElementById('data_type').value;
            const posFilterDiv = document.getElementById('pos-filter-group');
            
            // åªæœ‰åœ¨é¸æ“‡ 'vocab' (å–®å­—) æ™‚æ‰é¡¯ç¤ºè©æ€§ç¯©é¸
            if (dataType === 'vocab') {
                posFilterDiv.style.display = 'block';
            } else {
                posFilterDiv.style.display = 'none';
            }
        }
        
        // é é¢åŠ è¼‰æ™‚çš„åˆå§‹åŒ–è¨­ç½®
        document.addEventListener('DOMContentLoaded', () => {
            // 1. è¨­ç½®äº‹ä»¶ç›£è½å™¨ï¼šç•¶æ•¸æ“šé¡å‹æ”¹è®Šæ™‚ï¼Œåˆ‡æ›è©æ€§ç¯©é¸çš„é¡¯ç¤º
            togglePosFilter(); // åˆå§‹å‘¼å«ä»¥è¨­ç½®æ­£ç¢ºçš„é¡¯ç¤ºç‹€æ…‹
            document.getElementById('data_type').addEventListener('change', togglePosFilter);

            // 2. è¨­ç½®åˆå§‹ç‹€æ…‹æ–‡æœ¬ï¼Œé¿å…è‡ªå‹•åŠ è¼‰
            document.getElementById('last-index-info').innerText = "è«‹é¸æ“‡å…§å®¹å¾Œï¼Œé»æ“Šé–‹å§‹æŒ‰éˆ•ä»¥è¼‰å…¥æ•¸æ“šä¸¦é–‹å§‹å­¸ç¿’ã€‚";
        });

        // å‡½æ•¸ï¼šåŠ è¼‰æ•¸æ“šä¸¦æª¢æŸ¥ä¸Šæ¬¡é€²åº¦ï¼ŒæˆåŠŸå¾Œå°‡å–®å­—å¡æ•¸æ“šå­˜å…¥ Session
        async function loadAndCheckData() {
            const formData = new FormData(document.getElementById('flashcard-form'));
            const data = Object.fromEntries(formData.entries());

            const lastIndexInfoElement = document.getElementById('last-index-info');
            lastIndexInfoElement.innerText = "â³ æ­£åœ¨è¼‰å…¥æ•¸æ“šï¼Œè«‹ç¨å€™...";

            try {
                // ç™¼é€è«‹æ±‚ï¼Œæ­¤æ™‚ data åŒ…å«äº†ç•¶å‰é¸å®šçš„ data_type å’Œ pos_filter
                const response = await fetch("{{ url_for('get_flashcards') }}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.success && result.count > 0) {
                    // last_stored_index = result.last_index; // å¯¦éš›ä¸Šä¸å†éœ€è¦å„²å­˜åˆ° JS è®Šé‡ï¼ŒSession å·²å„²å­˜
                    lastIndexInfoElement.innerText = 
                        `âœ… æ•¸æ“šè¼‰å…¥æˆåŠŸï¼å…± ${result.count} ç­†ã€‚ä¸Šæ¬¡èƒŒåˆ°ç¬¬ ${result.last_index + 1} ç­†ã€‚`;
                    return true; // æ•¸æ“šåŠ è¼‰æˆåŠŸ
                } else if (result.count === 0) {
                    lastIndexInfoElement.innerText = "âŒ æ¸…å–®ä¸­æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ•¸æ“šï¼è«‹èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚";
                    alert("æ¸…å–®ä¸­æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„æ•¸æ“šï¼è«‹èª¿æ•´ç¯©é¸æ¢ä»¶ã€‚");
                    return false; // æ•¸æ“šç‚ºç©º
                } else {
                    lastIndexInfoElement.innerText = "âŒ æ•¸æ“šåŠ è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯æ—¥èªŒã€‚";
                    return false; // æ•¸æ“šåŠ è¼‰å¤±æ•—
                }
            } catch (error) {
                console.error('æ•¸æ“šåŠ è¼‰éŒ¯èª¤:', error);
                lastIndexInfoElement.innerText = "âŒ ç¶²çµ¡æˆ–ä¼ºæœå™¨éŒ¯èª¤ï¼Œæ•¸æ“šåŠ è¼‰å¤±æ•—ã€‚";
                return false;
            }
        }

        // å‡½æ•¸ï¼šå•Ÿå‹•å–®å­—å¡é é¢
        async function startDeck(action) {
            // 1. æ¯æ¬¡é»æ“Šé–‹å§‹æ™‚ï¼Œå…ˆå¼·åˆ¶åŠ è¼‰é¸å®šçš„æ•¸æ“šåˆ° Session
            const dataLoaded = await loadAndCheckData();

            if (!dataLoaded) {
                // å¦‚æœæ•¸æ“šåŠ è¼‰å¤±æ•—æˆ–ç‚ºç©ºï¼Œå‰‡åœæ­¢
                return;
            }
            
            // 2. åŠ è¼‰æˆåŠŸå¾Œï¼ŒåŸ·è¡Œå°èˆªåˆ°å–®å­—å¡é¡¯ç¤ºé é¢
            window.location.href = `{{ url_for('flashcard_deck', action='') }}${action}`;
        }
    </script>
</body>
</html>